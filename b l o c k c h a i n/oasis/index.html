<!doctype html><html lang=en-US><head><meta charset=utf-8><meta content="ie=edge" http-equiv=x-ua-compatible><meta content="width=device-width,initial-scale=1,shrink-to-fit=no" name=viewport><link href=https://phlip9.com/notes/main.css rel=stylesheet><meta content="index, follow" name=robots><meta content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1" name=googlebot><meta content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1" name=bingbot><title>oasis | philip's notes</title><meta content="a collection of my notes" name=description><link href="https://phlip9.com/notes/b l o c k c h a i n/oasis/" rel=canonical><meta content=summary name=twitter:card><meta content=oasis name=twitter:title><meta content=@phlip9 name=twitter:site><meta content=@phlip9 name=twitter:creator><meta content=oasis property=og:title><meta content="a collection of my notes" property=og:description><meta content=article property=og:type><meta content="https://phlip9.com/notes/b l o c k c h a i n/oasis/" property=og:url><meta content=2024-10-21T04:08:44.978615 property=og:updated_time><meta content="philip's notes" property=og:site_name><meta content=en_US property=og:locale><script type=application/ld+json>
  {
    "@context": "https://schema.org",
    "@type": "Article",
    "mainEntityOfPage": {
      "@type": "WebPage",
      "@id": "/b l o c k c h a i n/oasis/"
    },
    "headline": "oasis",
    "image": ,
    "datePublished": "2022-04-14",
    "dateModified": "2024-10-21",
    "author": {
      "@type": "Person",
      "name": "Philip Hayes"
    },
    "publisher": {
      "@type": "Person",
      "name": "Philip Hayes",
      
    },
    "description": "a collection of my notes"
  }
  </script><script type=application/ld+json>
  {
    "@context": "http://schema.org",
    "@type": "BreadcrumbList",
    
      
      
        
        
        
        
        
        
        
        
          {
            "@type": "ListItem",
            "position":  1 ,
            "name": "Home",
            "item": "https://phlip9.com/notes/"
          },
          
          
          {
            "@type": "ListItem",
            "position":  2 ,
            "name": "B L O C K C H A I N",
            "item": "https://phlip9.com/notes/b l o c k c h a i n/"
          },
        
      
        
        
        
        
        
        
        
        
          
          
          {
            "@type": "ListItem",
            "position":  3 ,
            "name": "Oasis",
            "item": "https://phlip9.com/notes/b l o c k c h a i n/oasis/"
          },
        
      
    
  }
</script><meta content=#383866 name=theme-color><link href=https://phlip9.com/notes/apple-touch-icon.png rel=apple-touch-icon sizes=180x180><link href=https://phlip9.com/notes/favicon-32x32.png rel=icon sizes=32x32 type=image/png><link href=https://phlip9.com/notes/favicon-16x16.png rel=icon sizes=16x16 type=image/png><link href=https://phlip9.com/notes/site.webmanifest rel=manifest><script>// https://mathjax.github.io/MathJax-demos-web/convert-configuration/convert-configuration.html
        window.MathJax = {
          tex: {
            inlineMath: [
              ['$', '$']
            ],
            displayMath: [
              ['$$', '$$'],
              ['\\[', '\\]']
            ],
            processEscapes: true,
            processEnvironments: true,
          },
          options: {
            skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
          }
        };</script><script integrity="sha256-z47L98YXVhVIaY0uyDzt675P5Ea+w3RsPh9VD5NuoTY=" async crossorigin=anonymous defer id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3.2.0/es5/tex-chtml.js></script><body class="notes single dark"><div class=container role=document><div class=content><div class="row flex-xl-nowrap"><div class="col-lg-5 col-xl-4 notes-sidebar"><nav aria-label="Main navigation" class=notes-links><a class="navbar-brand link-internal" href=https://phlip9.com/notes/> philip's notes </a><a class="notes-link sidebar-social" href=https://twitter.com/phlip9> <svg class="feather feather-twitter" viewbox="0 0 24 24" fill=none height=20 stroke=currentColor stroke-linecap=round stroke-linejoin=round stroke-width=2 width=20 xmlns=http://www.w3.org/2000/svg><path d="M23 3a10.9 10.9 0 0 1-3.14 1.53 4.48 4.48 0 0 0-7.86 3v1A10.66 10.66 0 0 1 3 4s-4 9 5 13a11.64 11.64 0 0 1-7 2c9 5 20 0 20-11.5a4.5 4.5 0 0 0-.08-.83A7.72 7.72 0 0 0 23 3z"></path></svg> <span class=visually-hidden>Twitter</span> </a><a class="notes-link sidebar-social" href=https://github.com/phlip9> <svg class="feather feather-github" viewbox="0 0 24 24" fill=none height=20 stroke=currentColor stroke-linecap=round stroke-linejoin=round stroke-width=2 width=20 xmlns=http://www.w3.org/2000/svg><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"></path></svg> <span class=visually-hidden>GitHub</span> </a><a class="notes-link sidebar-social" href=# id=sidebar-open-search> <svg aria-labelledby="title desc" viewbox="0 0 19.9 19.7" fill=none height=20 id=search-icon role=img stroke=currentColor stroke-linecap=round stroke-linejoin=round stroke-width=2 tabindex=0 width=20 xmlns=http://www.w3.org/2000/svg> <g class=search-path><path d="M18.5 18.3l-5.4-5.4"></path><circle cx=8 cy=8 r=7></circle> </g> </svg> </a><hr><ol id=sidebar-tree-root><li><input id=sidebar-input-ai-ml type=checkbox> <label class=h3 for=sidebar-input-ai-ml>AI ML</label> <ol><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/AI ML/Expectimax Search/"> Expectimax Search </a><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/AI ML/Markov Decision Process (MDP)/"> Markov Decision Process (MDP) </a></ol><li><input id=sidebar-input-wsl type=checkbox> <label class=h3 for=sidebar-input-wsl>WSL</label> <ol><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/WSL/WSL2 custom kernel/"> WSL2 custom kernel </a></ol><li><li><input id=sidebar-input-android type=checkbox> <label class=h3 for=sidebar-input-android>android</label> <ol><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/android/ADB over TCP inside WSL2/"> ADB over TCP inside WSL2 </a><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/android/OTA updates for rooted android phone/"> OTA updates for rooted android phone </a><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/android/android cli setup/"> android cli setup </a><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/android/building signal-android in WSL2/"> building signal-android in WSL2 </a><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/android/linux ADB udev setup/"> linux ADB udev setup </a><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/android/root phone with magisk/"> root phone with magisk </a></ol><li><input id=sidebar-input-b-i-g-m-o-n-e-y-l-a-w-r-e-g-u-l-a-t-i-o-n type=checkbox> <label class=h3 for=sidebar-input-b-i-g-m-o-n-e-y-l-a-w-r-e-g-u-l-a-t-i-o-n>b i g m o n e y l a w r e g u l a t i o n</label> <ol><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/b i g m o n e y l a w r e g u l a t i o n/financial instituion/"> financial instituion </a><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/b i g m o n e y l a w r e g u l a t i o n/foreign bank account report (FBAR)/"> foreign bank account report (FBAR) </a><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/b i g m o n e y l a w r e g u l a t i o n/monetary instruments/"> monetary instruments </a><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/b i g m o n e y l a w r e g u l a t i o n/money services business (MSB)/"> money services business (MSB) </a></ol><li><input checked id=sidebar-input-b-l-o-c-k-c-h-a-i-n type=checkbox> <label class=h3 for=sidebar-input-b-l-o-c-k-c-h-a-i-n>b l o c k c h a i n</label> <ol><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/b l o c k c h a i n/aptos/"> aptos </a><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/b l o c k c h a i n/bip158 - compact block filters/"> bip158 - compact block filters </a><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/b l o c k c h a i n/btc utreexo - utxo accumulator/"> btc utreexo - utxo accumulator </a><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/b l o c k c h a i n/fastpay/"> fastpay </a><li class=sidebar-note><a class="notes-link link-internal active" href="https://phlip9.com/notes/b l o c k c h a i n/oasis/"> oasis </a><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/b l o c k c h a i n/sui/"> sui </a></ol><li><input id=sidebar-input-btc-ln type=checkbox> <label class=h3 for=sidebar-input-btc-ln>btc-ln</label> <ol><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/btc-ln/BOLT 11 - invoices/"> BOLT 11 - invoices </a><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/btc-ln/BOLT 2 - channel management protocol/"> BOLT 2 - channel management protocol </a><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/btc-ln/BOLT 4 - onion routing protocol/"> BOLT 4 - onion routing protocol </a><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/btc-ln/BOLT 7 - p2p node and channel discovery/"> BOLT 7 - p2p node and channel discovery </a><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/btc-ln/BOLT 8 - secure noise transport/"> BOLT 8 - secure noise transport </a><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/btc-ln/atomic multipath payments (AMP)/"> atomic multipath payments (AMP) </a><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/btc-ln/breez lightning service providers/"> breez lightning service providers </a><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/btc-ln/hosted channels/"> hosted channels </a><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/btc-ln/lightning libs/"> lightning libs </a><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/btc-ln/lightning network notes/"> lightning network notes </a><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/btc-ln/lightning rod/"> lightning rod </a><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/btc-ln/lightningdevkit - rust-lightning/"> lightningdevkit - rust-lightning </a><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/btc-ln/submarine swaps/"> submarine swaps </a><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/btc-ln/zero-conf channels/"> zero-conf channels </a></ol><li><input id=sidebar-input-combinatorics type=checkbox> <label class=h3 for=sidebar-input-combinatorics>combinatorics</label> <ol><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/combinatorics/k-combinations of a multiset/"> k-combinations of a multiset </a></ol><li><input id=sidebar-input-confidential-computing type=checkbox> <label class=h3 for=sidebar-input-confidential-computing>confidential computing</label> <ol><li><input id=sidebar-input-confidential-computing-intel-sgx type=checkbox> <label class=h3 for=sidebar-input-confidential-computing-intel-sgx>intel SGX</label> <ol><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/confidential computing/intel SGX/SGX lingo/"> SGX lingo </a><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/confidential computing/intel SGX/overview/"> overview </a><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/confidential computing/intel SGX/remote attestation/"> remote attestation </a><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/confidential computing/intel SGX/sealing/"> sealing </a><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/confidential computing/intel SGX/secure time/"> secure time </a></ol><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/confidential computing/enarx (WASM TEE)/"> enarx (WASM TEE) </a><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/confidential computing/fortanix rust tutorial/"> fortanix rust tutorial </a><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/confidential computing/gramine/"> gramine </a><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/confidential computing/intel TDX/"> intel TDX </a><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/confidential computing/marblerun/"> marblerun </a><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/confidential computing/mystikos/"> mystikos </a><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/confidential computing/remote attestation protocols/"> remote attestation protocols </a></ol><li><input id=sidebar-input-crypto type=checkbox> <label class=h3 for=sidebar-input-crypto>crypto</label> <ol><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/crypto/(talk) authenticated data structures for stateless validation/"> (talk) authenticated data structures for stateless validation </a><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/crypto/TLS self-signed pubkey-only certs/"> TLS self-signed pubkey-only certs </a><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/crypto/acme protocol/"> acme protocol </a><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/crypto/biscuit authz/"> biscuit authz </a><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/crypto/dex - open-source OIDC & OAuth 2.0 provider/"> dex - open-source OIDC & OAuth 2.0 provider </a><li class=sidebar-note><a class="notes-link link-internal" href=https://phlip9.com/notes/crypto/hkdf-sha256/> hkdf-sha256 </a><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/crypto/smallstep - private online CA & ACME server/"> smallstep - private online CA & ACME server </a><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/crypto/tls exported keying material/"> tls exported keying material </a><li class=sidebar-note><a class="notes-link link-internal" href=https://phlip9.com/notes/crypto/zkdocs/> zkdocs </a></ol><li><input id=sidebar-input-design type=checkbox> <label class=h3 for=sidebar-input-design>design</label> <ol><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/design/form design/"> form design </a></ol><li><input id=sidebar-input-devops type=checkbox> <label class=h3 for=sidebar-input-devops>devops</label> <ol><li><input id=sidebar-input-devops-o11y type=checkbox> <label class=h3 for=sidebar-input-devops-o11y>o11y</label> <ol><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/devops/o11y/jaeger oss e2e tracing/"> jaeger oss e2e tracing </a></ol><li><input id=sidebar-input-devops-secrets type=checkbox> <label class=h3 for=sidebar-input-devops-secrets>secrets</label> <ol><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/devops/secrets/1password - secrets automation/"> 1password - secrets automation </a><li class=sidebar-note><a class="notes-link link-internal" href=https://phlip9.com/notes/devops/secrets/doppler/> doppler </a><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/devops/secrets/ejson (Shopify)/"> ejson (Shopify) </a><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/devops/secrets/ejson-kms (AWS)/"> ejson-kms (AWS) </a><li class=sidebar-note><a class="notes-link link-internal" href=https://phlip9.com/notes/devops/secrets/envkey/> envkey </a><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/devops/secrets/fortanix DSM/"> fortanix DSM </a><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/devops/secrets/mozilla SOPS/"> mozilla SOPS </a><li class=sidebar-note><a class="notes-link link-internal" href=https://phlip9.com/notes/devops/secrets/sops-nix/> sops-nix </a><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/devops/secrets/sy - share secrets safely/"> sy - share secrets safely </a></ol><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/devops/AKS - azure kubernetes service/"> AKS - azure kubernetes service </a><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/devops/algo wireguard VPN server/"> algo wireguard VPN server </a><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/devops/azure CLI/"> azure CLI </a><li class=sidebar-note><a class="notes-link link-internal" href=https://phlip9.com/notes/devops/consul/> consul </a><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/devops/deployment strategies/"> deployment strategies </a><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/devops/docker compose/"> docker compose </a><li class=sidebar-note><a class="notes-link link-internal" href=https://phlip9.com/notes/devops/k3s/> k3s </a><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/devops/kind (kubernetes in docker)/"> kind (kubernetes in docker) </a><li class=sidebar-note><a class="notes-link link-internal" href=https://phlip9.com/notes/devops/kubernetes/> kubernetes </a><li class=sidebar-note><a class="notes-link link-internal" href=https://phlip9.com/notes/devops/linkerd/> linkerd </a><li class=sidebar-note><a class="notes-link link-internal" href=https://phlip9.com/notes/devops/minikube/> minikube </a><li class=sidebar-note><a class="notes-link link-internal" href=https://phlip9.com/notes/devops/nomad/> nomad </a><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/devops/service mesh/"> service mesh </a></ol><li><input id=sidebar-input-distributed-systems type=checkbox> <label class=h3 for=sidebar-input-distributed-systems>distributed systems</label> <ol><li><input id=sidebar-input-distributed-systems-papers type=checkbox> <label class=h3 for=sidebar-input-distributed-systems-papers>papers</label> <ol><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/distributed systems/papers/(2020) Semi-Fast Byzantine-tolerant Shared Register without Reliable Broadcast/"> (2020) Semi-Fast Byzantine-tolerant Shared Register without Reliable Broadcast </a><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/distributed systems/papers/(2021) Leaderless Consensus/"> (2021) Leaderless Consensus </a></ol><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/distributed systems/the siren song of backpressure/"> the siren song of backpressure </a></ol><li><input id=sidebar-input-fuzzing type=checkbox> <label class=h3 for=sidebar-input-fuzzing>fuzzing</label> <ol><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/fuzzing/bolero - fuzzing + property testing/"> bolero - fuzzing + property testing </a><li class=sidebar-note><a class="notes-link link-internal" href=https://phlip9.com/notes/fuzzing/fuzzcheck-rs/> fuzzcheck-rs </a><li class=sidebar-note><a class="notes-link link-internal" href=https://phlip9.com/notes/fuzzing/fuzzing/> fuzzing </a></ol><li><input id=sidebar-input-ios type=checkbox> <label class=h3 for=sidebar-input-ios>ios</label> <ol><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/ios/ios setup/"> ios setup </a></ol><li><input id=sidebar-input-keyboards type=checkbox> <label class=h3 for=sidebar-input-keyboards>keyboards</label> <ol><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/keyboards/moergo glove80/"> moergo glove80 </a></ol><li><input id=sidebar-input-lang type=checkbox> <label class=h3 for=sidebar-input-lang>lang</label> <ol><li><input id=sidebar-input-lang-ats type=checkbox> <label class=h3 for=sidebar-input-lang-ats>ATS</label> <ol><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/lang/ATS/ATS2 Notes/"> ATS2 Notes </a><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/lang/ATS/Install ATS2/"> Install ATS2 </a></ol><li><input id=sidebar-input-lang-flutter type=checkbox> <label class=h3 for=sidebar-input-lang-flutter>flutter</label> <ol><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/lang/flutter/dart lang/"> dart lang </a><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/lang/flutter/flutter setup/"> flutter setup </a></ol><li><input id=sidebar-input-lang-rust type=checkbox> <label class=h3 for=sidebar-input-lang-rust>rust</label> <ol><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/lang/rust/optimizing binary size/"> optimizing binary size </a><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/lang/rust/rr with rust/"> rr with rust </a><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/lang/rust/rust verification tools/"> rust verification tools </a><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/lang/rust/rust x SGX/"> rust x SGX </a><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/lang/rust/self-referencing structs/"> self-referencing structs </a><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/lang/rust/sycamore x futures/"> sycamore x futures </a><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/lang/rust/understanding sycamore reactivity/"> understanding sycamore reactivity </a></ol><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/lang/gdb ref/"> gdb ref </a><li class=sidebar-note><a class="notes-link link-internal" href=https://phlip9.com/notes/lang/koka-lang/> koka-lang </a><li class=sidebar-note><a class="notes-link link-internal" href=https://phlip9.com/notes/lang/lua/> lua </a><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/lang/operator fixity and precedence/"> operator fixity and precedence </a></ol><li><input id=sidebar-input-management type=checkbox> <label class=h3 for=sidebar-input-management>management</label> <ol><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/management/relieve often - why generals were more successful in WWII/"> relieve often - why generals were more successful in WWII </a></ol><li><input id=sidebar-input-misc type=checkbox> <label class=h3 for=sidebar-input-misc>misc</label> <ol><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/misc/arm target triples/"> arm target triples </a><li class=sidebar-note><a class="notes-link link-internal" href=https://phlip9.com/notes/misc/envsubst/> envsubst </a><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/misc/git multirepo to monorepo/"> git multirepo to monorepo </a><li class=sidebar-note><a class="notes-link link-internal" href=https://phlip9.com/notes/misc/kintsugi/> kintsugi </a><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/misc/optimization solvers/"> optimization solvers </a><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/misc/pop_OS! tweaks/"> pop_OS! tweaks </a><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/misc/prepping RPI for embedded dev/"> prepping RPI for embedded dev </a><li class=sidebar-note><a class="notes-link link-internal" href=https://phlip9.com/notes/misc/rgbxmas/> rgbxmas </a><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/misc/scanning QR codes on desktop/"> scanning QR codes on desktop </a><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/misc/setting up a headless raspbian boot image/"> setting up a headless raspbian boot image </a><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/misc/uptime to downtime conversion/"> uptime to downtime conversion </a><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/misc/water distillation setup/"> water distillation setup </a></ol><li><input id=sidebar-input-networking type=checkbox> <label class=h3 for=sidebar-input-networking>networking</label> <ol><li class=sidebar-note><a class="notes-link link-internal" href=https://phlip9.com/notes/networking/CIDR/> CIDR </a><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/networking/ipv6 address space/"> ipv6 address space </a><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/networking/network interface card (NIC)/"> network interface card (NIC) </a><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/networking/network interfaces/"> network interfaces </a></ol><li><input id=sidebar-input-nvim type=checkbox> <label class=h3 for=sidebar-input-nvim>nvim</label> <ol><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/nvim/universal-ctags Notes/"> universal-ctags Notes </a></ol><li><input id=sidebar-input-performance type=checkbox> <label class=h3 for=sidebar-input-performance>performance</label> <ol><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/performance/bit hacks/"> bit hacks </a><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/performance/dtrace on macOS/"> dtrace on macOS </a><li class=sidebar-note><a class="notes-link link-internal" href=https://phlip9.com/notes/performance/profiling/> profiling </a><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/performance/simdjson talk/"> simdjson talk </a></ol><li><input id=sidebar-input-postgres type=checkbox> <label class=h3 for=sidebar-input-postgres>postgres</label> <ol><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/postgres/postgres performance tuning/"> postgres performance tuning </a><li class=sidebar-note><a class="notes-link link-internal" href=https://phlip9.com/notes/postgres/snippets/> snippets </a><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/postgres/types of scans/"> types of scans </a></ol><li><input id=sidebar-input-reproducible-builds type=checkbox> <label class=h3 for=sidebar-input-reproducible-builds>reproducible builds</label> <ol><li><input id=sidebar-input-reproducible-builds-nix type=checkbox> <label class=h3 for=sidebar-input-reproducible-builds-nix>nix</label> <ol><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/reproducible builds/nix/links/"> links </a><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/reproducible builds/nix/nix auto-allocate-uids -> nixbld users/"> nix auto-allocate-uids -> nixbld users </a><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/reproducible builds/nix/nix debug broken package build/"> nix debug broken package build </a><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/reproducible builds/nix/nix debug spurrious rebuilds/"> nix debug spurrious rebuilds </a></ol><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/reproducible builds/earthly/"> earthly </a><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/reproducible builds/rebuilderd/"> rebuilderd </a><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/reproducible builds/reproducible-builds.org/"> reproducible-builds.org </a></ol><li><input id=sidebar-input-router type=checkbox> <label class=h3 for=sidebar-input-router>router</label> <ol><li><input id=sidebar-input-router-lightning-router type=checkbox> <label class=h3 for=sidebar-input-router-lightning-router>lightning router</label> <ol><li><input id=sidebar-input-router-lightning-router-captive-portal type=checkbox> <label class=h3 for=sidebar-input-router-lightning-router-captive-portal>captive portal</label> <ol><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/router/lightning router/captive portal/RFC 6585 (Additional HTTP Status Codes)/"> RFC 6585 (Additional HTTP Status Codes) </a><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/router/lightning router/captive portal/arubanetworks captive portal/"> arubanetworks captive portal </a><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/router/lightning router/captive portal/captive portal/"> captive portal </a><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/router/lightning router/captive portal/captive portal (wikipedia)/"> captive portal (wikipedia) </a></ol><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/router/lightning router/lightning router overview/"> lightning router overview </a></ol></ol><li><input id=sidebar-input-statistics-probability type=checkbox> <label class=h3 for=sidebar-input-statistics-probability>statistics probability</label> <ol><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/statistics probability/CDF confidence bands - DKW inequality/"> CDF confidence bands - DKW inequality </a><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/statistics probability/G-test - multinomial goodness-of-fit/"> G-test - multinomial goodness-of-fit </a><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/statistics probability/MAD - median absolute deviation/"> MAD - median absolute deviation </a><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/statistics probability/cheat sheet/"> cheat sheet </a><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/statistics probability/herbie - float error fixer/"> herbie - float error fixer </a><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/statistics probability/kelly criterion + ELO/"> kelly criterion + ELO </a><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/statistics probability/multinomial distribution/"> multinomial distribution </a><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/statistics probability/p-value/"> p-value </a><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/statistics probability/standard error/"> standard error </a><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/statistics probability/testing whether a coin is fair/"> testing whether a coin is fair </a><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/statistics probability/winsorize/"> winsorize </a></ol></ol></nav></div><nav aria-label="Secondary navigation" class="notes-toc d-none d-xl-block col-xl-4"><div class=page-links><h3 class=text-muted>on this page</h3><nav id=table-of-contents><ul><li><a href="https://phlip9.com/notes/b l o c k c h a i n/oasis/#oasis" class=link-internal>oasis</a> <ul><li><a href="https://phlip9.com/notes/b l o c k c h a i n/oasis/#core-oasis-runtime-model" class=link-internal>Core Oasis Runtime Model</a> <ul><li><a href="https://phlip9.com/notes/b l o c k c h a i n/oasis/#oasis-core-runtime-loader" class=link-internal>oasis-core Runtime Loader</a><li><a href="https://phlip9.com/notes/b l o c k c h a i n/oasis/#oasis-core-host" class=link-internal>oasis-core Host</a><li><a href="https://phlip9.com/notes/b l o c k c h a i n/oasis/#runtime-host-protocol" class=link-internal>Runtime Host Protocol</a></ul></ul></ul></nav></div></nav><main class="notes-content tags-content col-lg-11 col-xl-8"><h1 id=oasis>oasis</h1><p class=text-muted>2022-04-14 Â· 13 min read<ul class=tags><li><a class="btn btn-outline-primary btn-sm link-internal" href=https://phlip9.com/notes/tags/blockchain/>#blockchain</a><li><a class="btn btn-outline-primary btn-sm link-internal" href=https://phlip9.com/notes/tags/sgx/>#sgx</a></ul><p>Site: <a href=https://oasisprotocol.org/>https://oasisprotocol.org/</a><p>Github: <a href=https://github.com/oasisprotocol/>https://github.com/oasisprotocol/</a>, <a href=https://github.com/oasisprotocol/oasis-sdk>oasis-sdk</a>, <a href=https://github.com/oasisprotocol/oasis-core>oasis-core</a><p><a href=https://github.com/oasisprotocol/oasis-core/tree/master/runtime/src>Lots of interesting/useful SGX-related stuff</a><p><a href=https://docs.oasis.dev/general/run-a-node/prerequisites/set-up-trusted-execution-environment-tee#check-sgx-setup>Oasis Run a Node Process (Setting up SGX)</a><p><a href=https://docs.oasis.dev/general/run-a-node/set-up-your-node/run-an-ias-proxy/>Run an Intel Attestation Service (IAS) proxy</a><p>TODO: enclave rpc<h3 id=core-oasis-runtime-model>Core Oasis Runtime Model <a aria-label="anchor link" class=anchor-link href=#core-oasis-runtime-model> # </a></h3><p>Oasis Core Compute Nodes run user executables inside SGX enclaves.<pre style=background-color:#2b303b;color:#c0c5ce;><code><span>               ____________________
</span><span>			  |  ________________  |
</span><span>              | | Runtime Loader | |
</span><span>			  | '----------------' |
</span><span>			  |      Enclave	   |
</span><span> ______       |  ________________  |
</span><span>| Node |&LT------>|  Runtime Bin   | |
</span><span>'______'      | '----------------' |
</span><span>              '--------------------'
</span></code></pre><ul><li>The Rust <a href=https://github.com/oasisprotocol/oasis-core/tree/master/runtime><code>oasis-core/runtime</code></a> is the in-enclave runtime. This is "Runtime Loader" and "Runtime Bin" in the above diagram.<li>The Go <a href=https://github.com/oasisprotocol/oasis-core/tree/master/go/runtime/host><code>oasis-core/go/runtime/host</code></a> is responsible for provisioning enclaves and then communicating with them. This is part of "Node" in the above diagram.<li>The Node and Runtime communicate via <ul><li>Node &LT-> Unix Socket &LT-> Enclave Runner &LT-> Fortanix shared-memory FIFO queue &LT-> Enclave Runtime Binary</ul></ul><h4 id=oasis-core-runtime-loader>oasis-core Runtime Loader <a aria-label="anchor link" class=anchor-link href=#oasis-core-runtime-loader> # </a></h4><p><a href=https://github.com/oasisprotocol/oasis-core/tree/master/runtime-loader>https://github.com/oasisprotocol/oasis-core/tree/master/runtime-loader</a><p>Inputs:<ol><li>Runtime Filename<li>Signature<li>host-socket</ol><p>SgxsLoader<ol><li>Opens the SGX kernel devices for loading enclaves.<li>Opens client connection to <a href=https://phlip9.com/notes/confidential%20computing/intel%20SGX/SGX%20lingo/#architectural-enclave-service-manager-aesm>AESM service</a> for the <a href=https://phlip9.com/notes/confidential%20computing/intel%20SGX/SGX%20lingo/#enclave-init-token-einittoken>EINITTOKEN</a> provider.<li>Build enclave from file, <a href=https://phlip9.com/notes/confidential%20computing/intel%20SGX/SGX%20lingo/#enclave-signature-struct-sigstruct>SIGSTRUCT</a> signature, and their custom adapter, which just routes <code>connect</code> syscalls from the enclave to a local Unix Domain Socket (UDS). This connection is the bidirectional arrow between <code>Node</code> and <code>Runtime Bin</code> in the above diagram.</ol><pre class=language-rust data-lang=rust style=background-color:#2b303b;color:#c0c5ce;><code class=language-rust data-lang=rust><span style=color:#65737e;>/// SGX runtime loader.
</span><span style=color:#b48ead;>pub struct </span><span>SgxsLoader;
</span><span>
</span><span style=color:#b48ead;>impl </span><span>Loader </span><span style=color:#b48ead;>for </span><span>SgxsLoader {
</span><span>    </span><span style=color:#b48ead;>fn </span><span style=color:#8fa1b3;>run</span><span>(
</span><span>        &</span><span style=color:#bf616a;>self</span><span>,
</span><span>        </span><span style=color:#bf616a;>filename</span><span>: String,
</span><span>        </span><span style=color:#bf616a;>signature_filename</span><span>: Option<&</span><span style=color:#b48ead;>str</span><span>>,
</span><span>        </span><span style=color:#bf616a;>host_socket</span><span>: String,
</span><span>    ) -> Fallible<()> {
</span><span>        </span><span style=color:#b48ead;>let</span><span> sig = </span><span style=color:#b48ead;>match</span><span> signature_filename {
</span><span>            Some(f) => f,
</span><span>            None => {
</span><span>                </span><span style=color:#b48ead;>return </span><span>Err(format_err!("</span><span style=color:#a3be8c;>signature file is required</span><span>"));
</span><span>            }
</span><span>        };
</span><span>
</span><span>        </span><span style=color:#65737e;>// Spawn the SGX enclave.
</span><span>        </span><span style=color:#b48ead;>let mut</span><span> device = IsgxDevice::new()?
</span><span>            .</span><span style=color:#96b5b4;>einittoken_provider</span><span>(AesmClient::new())
</span><span>            .</span><span style=color:#96b5b4;>build</span><span>();
</span><span>
</span><span>        </span><span style=color:#b48ead;>let mut</span><span> enclave_builder = EnclaveBuilder::new(filename.</span><span style=color:#96b5b4;>as_ref</span><span>());
</span><span>        enclave_builder.</span><span style=color:#96b5b4;>signature</span><span>(sig)?;
</span><span>        enclave_builder.</span><span style=color:#96b5b4;>usercall_extension</span><span>(HostService::new(host_socket));
</span><span>        </span><span style=color:#b48ead;>let</span><span> enclave = enclave_builder.</span><span style=color:#96b5b4;>build</span><span>(&</span><span style=color:#b48ead;>mut</span><span> device)?;
</span><span>
</span><span>        enclave.</span><span style=color:#96b5b4;>run</span><span>()
</span><span>    }
</span><span>}
</span></code></pre><h4 id=oasis-core-host>oasis-core Host <a aria-label="anchor link" class=anchor-link href=#oasis-core-host> # </a></h4><pre class=language-go data-lang=go style=background-color:#2b303b;color:#c0c5ce;><code class=language-go data-lang=go><span style=color:#65737e;>// Manifest is a deserialized runtime bundle manifest.
</span><span style=color:#b48ead;>type </span><span>Manifest </span><span style=color:#b48ead;>struct </span><span>{
</span><span>	</span><span style=color:#65737e;>// Name is the optional human readable runtime name.
</span><span>	</span><span style=color:#bf616a;>Name </span><span style=color:#b48ead;>string </span><span>`</span><span style=color:#a3be8c;>json:"name,omitempty"</span><span>`
</span><span>
</span><span>	</span><span style=color:#65737e;>// ID is the runtime ID.
</span><span>	</span><span style=color:#bf616a;>ID common</span><span>.</span><span style=color:#b48ead;>Namespace </span><span>`</span><span style=color:#a3be8c;>json:"id"</span><span>`
</span><span>
</span><span>	</span><span style=color:#65737e;>// Version is the runtime version.
</span><span>	</span><span style=color:#bf616a;>Version version</span><span>.</span><span style=color:#b48ead;>Version </span><span>`</span><span style=color:#a3be8c;>json:"version,omitempty"</span><span>`
</span><span>
</span><span>	</span><span style=color:#65737e;>// Executable is the name of the runtime ELF executable file.
</span><span>	</span><span style=color:#bf616a;>Executable </span><span style=color:#b48ead;>string </span><span>`</span><span style=color:#a3be8c;>json:"executable"</span><span>`
</span><span>
</span><span>	</span><span style=color:#65737e;>// SGX is the SGX specific manifest metadata if any.
</span><span>	</span><span style=color:#bf616a;>SGX </span><span>*</span><span style=color:#b48ead;>SGXMetadata </span><span>`</span><span style=color:#a3be8c;>json:"sgx,omitempty"</span><span>`
</span><span>
</span><span>	</span><span style=color:#65737e;>// Digests is the cryptographic digests of the bundle contents,
</span><span>	</span><span style=color:#65737e;>// excluding the manifest.
</span><span>	</span><span style=color:#bf616a;>Digests </span><span style=color:#b48ead;>map</span><span>[</span><span style=color:#b48ead;>string</span><span>]</span><span style=color:#bf616a;>hash</span><span>.</span><span style=color:#b48ead;>Hash </span><span>`</span><span style=color:#a3be8c;>json:"digests"</span><span>`
</span><span>}
</span><span>
</span><span style=color:#65737e;>// SGXMetadata is the SGX specific manifest metadata.
</span><span style=color:#b48ead;>type </span><span>SGXMetadata </span><span style=color:#b48ead;>struct </span><span>{
</span><span>	</span><span style=color:#65737e;>// Executable is the name of the SGX enclave executable file.
</span><span>	</span><span style=color:#bf616a;>Executable </span><span style=color:#b48ead;>string </span><span>`</span><span style=color:#a3be8c;>json:"executable"</span><span>`
</span><span>
</span><span>	</span><span style=color:#65737e;>// Signature is the name of the SGX enclave signature file.
</span><span>	</span><span style=color:#bf616a;>Signature </span><span style=color:#b48ead;>string </span><span>`</span><span style=color:#a3be8c;>json:"signature"</span><span>`
</span><span>}
</span><span>
</span><span style=color:#65737e;>// Bundle is a runtime bundle instance.
</span><span style=color:#b48ead;>type </span><span>Bundle </span><span style=color:#b48ead;>struct </span><span>{
</span><span>	</span><span style=color:#bf616a;>Manifest </span><span>*</span><span style=color:#b48ead;>Manifest
</span><span>	</span><span style=color:#bf616a;>Data     </span><span style=color:#b48ead;>map</span><span>[</span><span style=color:#b48ead;>string</span><span>][]</span><span style=color:#b48ead;>byte
</span><span>}
</span><span>
</span><span>
</span><span style=color:#65737e;>// RuntimeBundle is a exploded runtime bundle ready for execution.
</span><span style=color:#b48ead;>type </span><span>RuntimeBundle </span><span style=color:#b48ead;>struct </span><span>{
</span><span>	*</span><span style=color:#bf616a;>bundle</span><span>.</span><span style=color:#a3be8c;>Bundle
</span><span>
</span><span>	</span><span style=color:#65737e;>// Exeuctable is the path to the extracted ELF or TEE executable.
</span><span>	</span><span style=color:#bf616a;>Path </span><span style=color:#b48ead;>string
</span><span>}
</span><span>
</span><span style=color:#65737e;>// Config contains common configuration for the provisioned runtime.
</span><span style=color:#b48ead;>type </span><span>Config </span><span style=color:#b48ead;>struct </span><span>{
</span><span>	</span><span style=color:#65737e;>// Bundle is the runtime bundle.
</span><span>	</span><span style=color:#bf616a;>Bundle </span><span>*</span><span style=color:#b48ead;>RuntimeBundle
</span><span>
</span><span>	</span><span style=color:#65737e;>// Extra is an optional provisioner-specific configuration.
</span><span>	</span><span style=color:#bf616a;>Extra </span><span style=color:#b48ead;>interface</span><span>{}
</span><span>
</span><span>	</span><span style=color:#65737e;>// MessageHandler is the message handler for the Runtime Host Protocol messages.
</span><span>	</span><span style=color:#bf616a;>MessageHandler protocol</span><span>.</span><span style=color:#b48ead;>Handler
</span><span>
</span><span>	</span><span style=color:#65737e;>// LocalConfig is the node-local runtime configuration.
</span><span>	</span><span style=color:#bf616a;>LocalConfig </span><span style=color:#b48ead;>map</span><span>[</span><span style=color:#b48ead;>string</span><span>]</span><span style=color:#b48ead;>interface</span><span>{}
</span><span>}
</span></code></pre><h4 id=runtime-host-protocol>Runtime Host Protocol <a aria-label="anchor link" class=anchor-link href=#runtime-host-protocol> # </a></h4><p>This is the core API layer available for executables running inside an SGX enclave. Nodes communicate bidirectionalyl with the running user binary via a bespoke length-prefixed CBOR message stream protocol.<h5 id=connection-lifecycle>Connection Lifecycle <a aria-label="anchor link" class=anchor-link href=#connection-lifecycle> # </a></h5><ul><li><code>Uninitialized</code> - Newly created connection. Must be initialized before use.<li><code>Inititalizing</code> - Parties exchange version and feature info.<li><code>Ready</code> - The versions and features are negotiated; however, we first need to perform remote attestation before running stuff in the enclave.<li><code>Closed</code> - Connection is closed.</ul><h5 id=remote-attestation>Remote Attestation <a aria-label="anchor link" class=anchor-link href=#remote-attestation> # </a></h5><p><a href=https://github.com/oasisprotocol/oasis-core/blob/07bc8cdf39b274ff9171eebc365ceb0842750717/go/runtime/host/sgx/sgx.go>Host attestation flow - oasis-core/go/runtime/host/sgx/sgx.go</a><ol><li>(Host) get the <a href=https://phlip9.com/notes/confidential%20computing/intel%20SGX/SGX%20lingo/#quoting-enclave-qe>Quoting Enclave (QE)</a>'s <a href=https://phlip9.com/notes/confidential%20computing/intel%20SGX/SGX%20lingo/#quoting-enclave-quoteinfo>QuoteInfo</a> from the <a href=https://phlip9.com/notes/confidential%20computing/intel%20SGX/SGX%20lingo/#architectural-enclave-service-manager-aesm>AESM</a>.<li>(Host) get the Service Provider ID (SPID) from the <a href=https://phlip9.com/notes/confidential%20computing/intel%20SGX/SGX%20lingo/#intel-attestation-services-ias>Intel Attestation Services (IAS)</a> cache.<li>(Host) send a <code>RuntimeCapabilityTEERakInitRequest { QuoteInfo.TargetInfo }</code> request to the enclave.<li>(Enclave) receive the request. initialize the <a href=https://phlip9.com/notes/b%20l%20o%20c%20k%20c%20h%20a%20i%20n/oasis/#runtime-attestation-key-rak>Runtime Attestation Key (RAK)</a> with the <code>TargetInfo</code> and then generate a new ephemeral <a href=https://phlip9.com/notes/b%20l%20o%20c%20k%20c%20h%20a%20i%20n/oasis/#runtime-attestation-key-rak>RAK</a> keypair (if one doesn't exist already).<li>(Host) ask the <a href=https://phlip9.com/notes/confidential%20computing/intel%20SGX/SGX%20lingo/#intel-attestation-services-ias>IAS</a> cache for the latest EPID revocation list (since Oasis uses EPID).<li>(Host) send a <code>RuntimeCapabilityTEERakReportRequest {}</code> to the enclave.<li>(Enclave) receive the request. <ol><li>Sample a random <code>nonce</code>.<li>Generate <code>report_body = H(RAK_pub)</code>. This binds the RAK pubkey to the report.<li>Set <code>report_data = report_body || nonce</code>.<li>Generate <code>report = Report::for_target(target_info, report_data)</code> from the enclave <code>EREPORT</code> instruction. See: <a href=https://phlip9.com/notes/confidential%20computing/intel%20SGX/SGX%20lingo/#report-ereport>Report (EREPORT)</a>.<li>Return the RAK public key, <code>report</code>, and <code>nonce</code> to the host.</ol><li>(Host) Request a <a href=https://phlip9.com/notes/confidential%20computing/intel%20SGX/SGX%20lingo/#quote>Quote</a> from the AESM using the <code>report</code>, SPID, and <code>sigRL</code> revocation list. For some reason the <code>nonce</code> is empty here? Not sure what the nonce here is for...<li>(Host) Verify that the <code>quote.Report</code> contains a <a href=https://phlip9.com/notes/confidential%20computing/intel%20SGX/SGX%20lingo/#enclave-measurement-mrenclave>MRENCLAVE</a> and <a href=https://phlip9.com/notes/confidential%20computing/intel%20SGX/SGX%20lingo/#signer-measurement-mrsigner>MRSIGNER</a> that we expect. This ensures we're talking to the right application enclave.<li>(Host) Verify that the <code>Quote.Report.Attributes.is_debug == config.is_debug</code>. That way we don't trust debug enclaves in production and don't use production enclaves in testing.<li>(Host) Ask the <a href=https://phlip9.com/notes/confidential%20computing/intel%20SGX/SGX%20lingo/#intel-attestation-services-ias>IAS</a> to Verify <code>Evidence { quote, nonce }</code>. IAS will return an <a href=https://phlip9.com/notes/b%20l%20o%20c%20k%20c%20h%20a%20i%20n/oasis/#enclave-attestation-verification-report-avr-handling>Attestation Verification Report (AVR)</a> to us.<li>(Host) send a <code>RuntimeCapabilityTEERakAvrRequest { avr }</code> request to the enclave, to pass it the AVR. <ol><li>(Q: why does the enclave need to verify the AVR? shouldn't the client do this? I suppose we already checked that the enclave is the one we expect; in which case, we trust it to verify the AVR correctly.)</ol><li>(Enclave) receive the <code>AVR</code> in the request. <ol><li>Expect the <code>nonce</code> in the AVR to match the one we generated above in step (7.1).<li>See <a href=https://phlip9.com/notes/b%20l%20o%20c%20k%20c%20h%20a%20i%20n/oasis/#enclave-attestation-verification-report-avr-handling>Enclave Attestation Verification Report AVR handling</a>.<li>Verify the current measured Report's enclave identity matches the enclave identity in the <code>AVR</code>.<li>Verify that the RAK pubkey matches the one in the <code>AVR.report_data</code>.<li>Verify that the <code>nonce</code> also matches the one in the <code>AVR.report_data</code>.<li>Ratchet our internal timestamp from the one we've observed.</ol><li>(Host) we've now fully verified the enclave. package up the RAK pubkey and AVR into a <code>capabilityTEE</code>.</ol><p>Other nodes can also verify the <code>capabilityTEE</code> by<ol><li>checking the <code>AVR</code> against the Intel Trust Root CA<li>checking the <code>MRENCLAVE</code>/<code>MRSIGNER</code> are what we expect<li>checking that the <code>AVR.Quote.Report.ReportData</code> includes the expected RAK pubkey</ol><pre style=background-color:#2b303b;color:#c0c5ce;><code><span>type SPIDInfo struct {
</span><span>	SPID               ias.SPID
</span><span>	QuoteSignatureType ias.SignatureType
</span><span>}
</span><span>
</span><span>// A deserialized AVRBundle from IAS.
</span><span>type AttestationVerificationReport struct {
</span><span>	ID                    string                `json:"id"`
</span><span>	Timestamp             string                `json:"timestamp"`
</span><span>	Version               int                   `json:"version"`
</span><span>	ISVEnclaveQuoteStatus ISVEnclaveQuoteStatus `json:"isvEnclaveQuoteStatus"`
</span><span>	ISVEnclaveQuoteBody   []byte                `json:"isvEnclaveQuoteBody"`
</span><span>	RevocationReason      *CRLReason            `json:"revocationReason"`
</span><span>	PSEManifestStatus     *PSEManifestStatus    `json:"pseManifestStatus"`
</span><span>	PSEManifestHash       string                `json:"pseManifestHash"`
</span><span>	PlatformInfoBlob      string                `json:"platformInfoBlob"`
</span><span>	Nonce                 string                `json:"nonce"`
</span><span>	EPIDPseudonym         []byte                `json:"epidPseudonym"`
</span><span>	AdvisoryURL           string                `json:"advisoryURL"`
</span><span>	AdvisoryIDs           []string              `json:"advisoryIDs"`
</span><span>}
</span></code></pre><p>See: <a href=https://phlip9.com/notes/confidential%20computing/intel%20SGX/SGX%20lingo/#quoting-enclave-quoteinfo>Quoting Enclave's QuoteInfo</a><h5 id=enclave-attestation-verification-report-avr-handling>Enclave Attestation Verification Report (AVR) handling <a aria-label="anchor link" class=anchor-link href=#enclave-attestation-verification-report-avr-handling> # </a></h5><p><a href=https://github.com/oasisprotocol/oasis-core/blob/master/runtime/src/common/sgx/avr.rs>https://github.com/oasisprotocol/oasis-core/blob/master/runtime/src/common/sgx/avr.rs</a><pre class=language-rust data-lang=rust style=background-color:#2b303b;color:#c0c5ce;><code class=language-rust data-lang=rust><span style=color:#65737e;>// AVR signature validation constants.
</span><span style=color:#b48ead;>const </span><span style=color:#d08770;>IAS_TRUST_ANCHOR_PEM</span><span>: Vec<</span><span style=color:#b48ead;>u8</span><span>> = </span><span style=color:#96b5b4;>parse_x509_pem</span><span>(
</span><span>	</span><span style=color:#b48ead;>r</span><span>#"</span><span style=color:#a3be8c;>-----BEGIN CERTIFICATE-----
</span><span style=color:#a3be8c;>	MIIFSzCCA7OgAwIBAgIJANEHdl0yo7CUMA0GCSqGSIb3DQEBCwUAMH4xCzAJBgNV
</span><span style=color:#a3be8c;>	..
</span><span style=color:#a3be8c;>	DD+gT9sSpssq0ascmvH49MOgjt1yoysLtdCtJW/9FZpoOypaHx0R+mJTLwPXVMrv
</span><span style=color:#a3be8c;>	DaVzWh5aiEx+idkSGMnX
</span><span style=color:#a3be8c;>	-----END CERTIFICATE-----</span><span>"#
</span><span>).</span><span style=color:#96b5b4;>unwrap</span><span>();
</span><span style=color:#b48ead;>const </span><span style=color:#d08770;>PEM_CERTIFICATE_LABEL</span><span>: &</span><span style=color:#b48ead;>str </span><span>= "</span><span style=color:#a3be8c;>CERTIFICATE</span><span>";
</span><span style=color:#b48ead;>const </span><span style=color:#d08770;>IAS_TS_FMT</span><span>: &</span><span style=color:#b48ead;>str </span><span>= "</span><span style=color:#a3be8c;>%FT%T%.6f</span><span>";
</span><span>
</span><span style=color:#65737e;>/// Attestation verification report.
</span><span>#[</span><span style=color:#bf616a;>derive</span><span>(Debug, Clone, cbor::Encode, cbor::Decode)]
</span><span style=color:#b48ead;>pub struct </span><span>AVR {
</span><span>	</span><span style=color:#65737e;>// json blob
</span><span>	</span><span style=color:#65737e;>//
</span><span>	</span><span style=color:#65737e;>// { "isvEnclaveQuoteStatues": __
</span><span>	</span><span style=color:#65737e;>// , "isvEnclaveQuoteBody": __
</span><span>	</span><span style=color:#65737e;>// , "timestamp": __
</span><span>	</span><span style=color:#65737e;>// , "nonce": __
</span><span>    </span><span style=color:#65737e;>// }
</span><span>    </span><span style=color:#b48ead;>pub </span><span style=color:#bf616a;>body</span><span>: Vec<</span><span style=color:#b48ead;>u8</span><span>>,
</span><span>    </span><span style=color:#b48ead;>pub </span><span style=color:#bf616a;>signature</span><span>: Vec<</span><span style=color:#b48ead;>u8</span><span>>,
</span><span>    </span><span style=color:#b48ead;>pub </span><span style=color:#bf616a;>certificate_chain</span><span>: Vec<</span><span style=color:#b48ead;>u8</span><span>>,
</span><span>}
</span><span>
</span><span style=color:#65737e;>/// Enclave identity.
</span><span>#[</span><span style=color:#bf616a;>derive</span><span>(Debug, Clone, Hash, Eq, PartialEq, cbor::Encode, cbor::Decode)]
</span><span style=color:#b48ead;>pub struct </span><span>EnclaveIdentity {
</span><span>    </span><span style=color:#b48ead;>pub </span><span style=color:#bf616a;>mr_enclave</span><span>: MrEnclave,
</span><span>    </span><span style=color:#b48ead;>pub </span><span style=color:#bf616a;>mr_signer</span><span>: MrSigner,
</span><span>}
</span><span>
</span><span style=color:#65737e;>/// Authenticated information obtained from validating an AVR.
</span><span>#[</span><span style=color:#bf616a;>derive</span><span>(Debug, Clone)]
</span><span style=color:#b48ead;>pub struct </span><span>AuthenticatedAVR {
</span><span>    </span><span style=color:#b48ead;>pub </span><span style=color:#bf616a;>report_data</span><span>: Vec<</span><span style=color:#b48ead;>u8</span><span>>,
</span><span>    </span><span style=color:#65737e;>// TODO: add other av report/quote body/report fields we want to give
</span><span>	</span><span style=color:#65737e;>//       the consumer
</span><span>    </span><span style=color:#b48ead;>pub </span><span style=color:#bf616a;>identity</span><span>: EnclaveIdentity,
</span><span>    </span><span style=color:#b48ead;>pub </span><span style=color:#bf616a;>timestamp</span><span>: </span><span style=color:#b48ead;>i64</span><span>,
</span><span>    </span><span style=color:#b48ead;>pub </span><span style=color:#bf616a;>nonce</span><span>: String,
</span><span>}
</span><span>
</span><span style=color:#65737e;>/// Decoded quote body.
</span><span>#[</span><span style=color:#bf616a;>derive</span><span>(Default, Debug)]
</span><span style=color:#b48ead;>struct </span><span>QuoteBody {
</span><span>    </span><span style=color:#bf616a;>version</span><span>: </span><span style=color:#b48ead;>u16</span><span>,
</span><span>    </span><span style=color:#bf616a;>signature_type</span><span>: </span><span style=color:#b48ead;>u16</span><span>,
</span><span>    </span><span style=color:#bf616a;>gid</span><span>: </span><span style=color:#b48ead;>u32</span><span>,
</span><span>    </span><span style=color:#bf616a;>isv_svn_qe</span><span>: </span><span style=color:#b48ead;>u16</span><span>,
</span><span>    </span><span style=color:#bf616a;>isv_svn_pce</span><span>: </span><span style=color:#b48ead;>u16</span><span>,
</span><span>    </span><span style=color:#bf616a;>basename</span><span>: [</span><span style=color:#b48ead;>u8</span><span>; 32],
</span><span>    </span><span style=color:#bf616a;>report_body</span><span>: Report,
</span><span>}
</span><span>
</span><span style=color:#b48ead;>impl </span><span>AVR {
</span><span>	</span><span style=color:#b48ead;>pub fn </span><span style=color:#8fa1b3;>verify</span><span>(&</span><span style=color:#bf616a;>self</span><span>) -> Result&LTAuthenticatedAVR> {
</span><span>		</span><span style=color:#65737e;>// 1. read configs if we should skip verification during
</span><span>		</span><span style=color:#65737e;>//    fuzzing/testing.
</span><span>		</span><span style=color:#65737e;>// 2. validate_avr_signature(self.cert_chain, self.body,
</span><span>		</span><span style=color:#65737e;>//    self.sig. time::now())
</span><span>		</span><span style=color:#65737e;>// 3. check if timestamp in AVR is too old
</span><span>		</span><span style=color:#65737e;>// 4. verify ISV Enclave Quote Status == OK | SW_HARDENING_NEEDED
</span><span>		</span><span style=color:#65737e;>//    if lax verification enabled, also allow some other errors
</span><span>		</span><span style=color:#65737e;>// 5. base64 decode ISV Enclave Quote Body, then decode to `QuoteBody`
</span><span>		</span><span style=color:#65737e;>// 6. Possibly allow debug enclaves if appropriate config.
</span><span>		</span><span style=color:#65737e;>// 7. They appear to use the IAS timestamp as a semi-trusted source
</span><span>		</span><span style=color:#65737e;>//    and ratchet their local clock forward if the IAS timestamp is
</span><span>		</span><span style=color:#65737e;>//    farther ahead.
</span><span>	}
</span><span>}
</span><span>
</span><span style=color:#b48ead;>fn </span><span style=color:#8fa1b3;>validate_avr_signature</span><span>(
</span><span>	</span><span style=color:#bf616a;>cert_chain</span><span>: &[</span><span style=color:#b48ead;>u8</span><span>],
</span><span>	</span><span style=color:#bf616a;>message</span><span>: &[</span><span style=color:#b48ead;>u8</span><span>],
</span><span>	</span><span style=color:#bf616a;>signature</span><span>: &[</span><span style=color:#b48ead;>u8</span><span>],
</span><span>	</span><span style=color:#bf616a;>unix_timestamp</span><span>: </span><span style=color:#b48ead;>u64</span><span>,
</span><span>) -> Result<()> {
</span><span>	</span><span style=color:#65737e;>// * They note that they're doing some funky process that barely resembles
</span><span>	</span><span style=color:#65737e;>//   the standard cert verification process.
</span><span>	</span><span style=color:#65737e;>// * Don't do cert revocation checks.
</span><span>	</span><span style=color:#65737e;>// * Intel Docs: The AVR is signed by the Report Signing Key using
</span><span>	</span><span style=color:#65737e;>//   RSA-SHA256
</span><span>	</span><span style=color:#65737e;>// * Intel Docs: The Report Signing pubkey is distributed via an x509
</span><span>	</span><span style=color:#65737e;>//   cert. This cert is a leaf cert issued by the "Attestation Report
</span><span>	</span><span style=color:#65737e;>//   Signing CA".
</span><span>	</span><span style=color:#65737e;>// * A PEM-encoded cert chain is (1) the Report Signing Key Cert and (2)
</span><span>	</span><span style=color:#65737e;>//   the Report Signing CA.
</span><span>
</span><span>	</span><span style=color:#65737e;>// 1. PEM decode the cert chain to DER. Check that each cert has the
</span><span>	</span><span style=color:#65737e;>//    "CERTIFICATE" label.
</span><span>	</span><span style=color:#65737e;>// 2. Check that only two certs were returned.
</span><span>	</span><span style=color:#65737e;>// 3. Ensure the last cert is the Report Signing CA (IAS_TRUST_ANCHOR).
</span><span>	</span><span style=color:#65737e;>// 4. Ensure the CA cert is not expired, is a CA cert, is self-signed.
</span><span>	</span><span style=color:#65737e;>// 5. Parse the leaf cert, verify the usual stuff, check CA sig.
</span><span>	</span><span style=color:#65737e;>// 6. Pull out the leaf pubkey. Verify `signature` on `message`. The
</span><span>	</span><span style=color:#65737e;>//    pubkey should be an RSA PKCS1 DER-encoded pubkey. The sig should be
</span><span>	</span><span style=color:#65737e;>//    RSA-SHA256 PKCS1v15.
</span><span>}
</span></code></pre><h5 id=runtime-attestation-key-rak>Runtime Attestation Key (RAK) <a aria-label="anchor link" class=anchor-link href=#runtime-attestation-key-rak> # </a></h5><p>RAK is the identity of the enclave, used to sign remote attestations.<pre class=language-rust data-lang=rust style=background-color:#2b303b;color:#c0c5ce;><code class=language-rust data-lang=rust><span style=color:#65737e;>/// The runtime attestation key (RAK) represents the identity of the enclave
</span><span style=color:#65737e;>/// and can be used to sign remote attestations. Its purpose is to avoid
</span><span style=color:#65737e;>/// round trips to IAS for each verification as the verifier can instead
</span><span style=color:#65737e;>/// verify the RAK signature and the signature on the provided AVR which
</span><span style=color:#65737e;>/// RAK to the enclave.
</span><span style=color:#b48ead;>pub struct </span><span>RAK {
</span><span>    </span><span style=color:#bf616a;>inner</span><span>: RwLock&LTInner>,
</span><span>}
</span><span>
</span><span style=color:#b48ead;>struct </span><span>Inner {
</span><span>    </span><span style=color:#bf616a;>private_key</span><span>: Option&LTPrivateKey>,
</span><span>    </span><span style=color:#bf616a;>avr</span><span>: Option&LTArc&LTavr::AVR>>,
</span><span>    </span><span style=color:#bf616a;>avr_timestamp</span><span>: Option<</span><span style=color:#b48ead;>i64</span><span>>,
</span><span>    #[</span><span style=color:#bf616a;>allow</span><span>(unused)]
</span><span>    </span><span style=color:#bf616a;>enclave_identity</span><span>: Option&LTavr::EnclaveIdentity>,
</span><span>    #[</span><span style=color:#bf616a;>allow</span><span>(unused)]
</span><span>    </span><span style=color:#bf616a;>target_info</span><span>: Option&LTTargetinfo>,
</span><span>    #[</span><span style=color:#bf616a;>allow</span><span>(unused)]
</span><span>    </span><span style=color:#bf616a;>nonce</span><span>: Option&LTString>,
</span><span>}
</span></code></pre><h5 id=egetkey>EGETKEY <a aria-label="anchor link" class=anchor-link href=#egetkey> # </a></h5><p><a href=https://github.com/oasisprotocol/oasis-core/blob/master/runtime/src/common/sgx/egetkey.rs>https://github.com/oasisprotocol/oasis-core/blob/master/runtime/src/common/sgx/egetkey.rs</a><ul><li>KMac: SHA3-256 Keccak MAC</ul><pre class=language-rust data-lang=rust style=background-color:#2b303b;color:#c0c5ce;><code class=language-rust data-lang=rust><span style=color:#65737e;>/// egetkey returns a 256 bit key suitable for sealing secrets to the
</span><span style=color:#65737e;>/// enclave in cold storage, derived from the results of the `EGETKEY`
</span><span style=color:#65737e;>/// instruction.  The `context` field is a domain separation tag.
</span><span style=color:#65737e;>///
</span><span style=color:#65737e;>/// Note: The key can also be used for other things (eg: as an X25519
</span><span style=color:#65737e;>/// private key).
</span><span style=color:#b48ead;>pub fn </span><span style=color:#8fa1b3;>egetkey</span><span>(</span><span style=color:#bf616a;>key_policy</span><span>: Keypolicy, </span><span style=color:#bf616a;>context</span><span>: &[</span><span style=color:#b48ead;>u8</span><span>]) -> [</span><span style=color:#b48ead;>u8</span><span>; </span><span style=color:#d08770;>32</span><span>] {
</span><span>    </span><span style=color:#b48ead;>let mut</span><span> k = [</span><span style=color:#d08770;>0</span><span style=color:#b48ead;>u8</span><span>; </span><span style=color:#d08770;>32</span><span>];
</span><span>
</span><span>    </span><span style=color:#65737e;>// Obtain the per-CPU package SGX sealing key, with the requested
</span><span>    </span><span style=color:#65737e;>// policy.
</span><span>    </span><span style=color:#b48ead;>let</span><span> master_secret = </span><span style=color:#96b5b4;>egetkey_impl</span><span>(key_policy, context);
</span><span>
</span><span>    </span><span style=color:#65737e;>// Expand the 128 bit EGETKEY result into a 256 bit key, suitable
</span><span>    </span><span style=color:#65737e;>// for use with our MRAE primitives.
</span><span>    </span><span style=color:#b48ead;>let mut</span><span> kdf = KMac::new_kmac256(
</span><span>		&master_secret,
</span><span>		</span><span style=color:#b48ead;>b</span><span>"</span><span style=color:#a3be8c;>Ekiden Expand SGX Seal Key</span><span>",
</span><span>	);
</span><span>    kdf.</span><span style=color:#96b5b4;>update</span><span>(context);
</span><span>    kdf.</span><span style=color:#96b5b4;>finalize</span><span>(&</span><span style=color:#b48ead;>mut</span><span> k);
</span><span>
</span><span>    k
</span><span>}
</span><span>
</span><span style=color:#65737e;>/// The SGX impl
</span><span style=color:#b48ead;>fn </span><span style=color:#8fa1b3;>egetkey_impl</span><span>(
</span><span>	</span><span style=color:#65737e;>// MRSIGNER or MRENCLAVE
</span><span>	</span><span style=color:#bf616a;>key_policy</span><span>: Keypolicy,
</span><span>	</span><span style=color:#65737e;>// the domain separation value
</span><span>	</span><span style=color:#bf616a;>context</span><span>: &[</span><span style=color:#b48ead;>u8</span><span>],
</span><span>) -> [</span><span style=color:#b48ead;>u8</span><span>; </span><span style=color:#d08770;>16</span><span>] {
</span><span>	</span><span style=color:#65737e;>// As we can see, using the Keyrequest::default() means oasis-core doesn't
</span><span>	</span><span style=color:#65737e;>// bind the key
</span><span>    </span><span style=color:#b48ead;>let mut</span><span> req = Keyrequest::default();
</span><span>    req.keyname = Keyname::Seal as </span><span style=color:#b48ead;>u16</span><span>;
</span><span>    req.keypolicy = key_policy;
</span><span>
</span><span>    </span><span style=color:#b48ead;>let mut</span><span> sha3 = Sha3::v256();
</span><span>    sha3.</span><span style=color:#96b5b4;>update</span><span>(context);
</span><span>    </span><span style=color:#b48ead;>let mut</span><span> k = [</span><span style=color:#d08770;>0</span><span>; </span><span style=color:#d08770;>32</span><span>];
</span><span>    sha3.</span><span style=color:#96b5b4;>finalize</span><span>(&</span><span style=color:#b48ead;>mut</span><span> k);
</span><span>    req.keyid = k;
</span><span>
</span><span>    </span><span style=color:#65737e;>// Fucking sgx_isa::Attributes doesn't have a -> [u64;2].
</span><span>	</span><span style=color:#65737e;>// SGX_FLAGS_INITTED | SGX_FLAGS_DEBUG | SGX_FLAGS_MODE64BIT
</span><span>    req.attributemask[</span><span style=color:#d08770;>0</span><span>] = </span><span style=color:#d08770;>1 </span><span>| </span><span style=color:#d08770;>2 </span><span>| </span><span style=color:#d08770;>4</span><span>;
</span><span>	</span><span style=color:#65737e;>// SGX_XFRM_LEGACY
</span><span>    req.attributemask[</span><span style=color:#d08770;>1</span><span>] = </span><span style=color:#d08770;>3</span><span>;
</span><span>
</span><span>    </span><span style=color:#b48ead;>match</span><span> req.</span><span style=color:#96b5b4;>egetkey</span><span>() {
</span><span>        Err(e) => panic!("</span><span style=color:#a3be8c;>EGETKEY failed: {:?}</span><span>", e),
</span><span>        Ok(k) => k,
</span><span>    }
</span><span>}
</span></code></pre><h5 id=sealing>Sealing <a aria-label="anchor link" class=anchor-link href=#sealing> # </a></h5><p><a href=https://github.com/oasisprotocol/oasis-core/blob/master/runtime/src/common/sgx/seal.rs>https://github.com/oasisprotocol/oasis-core/blob/master/runtime/src/common/sgx/seal.rs</a><ul><li>DeoxysII - Some new symmetric key AEAD cipher that uses AESNI. Not sure why they use this and not just like AES-GCM or AES-SIV. Maybe safer nonce reuse protection?</ul><pre class=language-rust data-lang=rust style=background-color:#2b303b;color:#c0c5ce;><code class=language-rust data-lang=rust><span style=color:#65737e;>/// Query the enclave for sealing key material with the current context and
</span><span style=color:#65737e;>/// key policy, then generate a DeoxysII symmetric key using the key material.
</span><span style=color:#b48ead;>fn </span><span style=color:#8fa1b3;>new_d2</span><span>(</span><span style=color:#bf616a;>key_policy</span><span>: Keypolicy, </span><span style=color:#bf616a;>context</span><span>: &[</span><span style=color:#b48ead;>u8</span><span>]) -> DeoxysII {
</span><span>    </span><span style=color:#b48ead;>let mut</span><span> seal_key = </span><span style=color:#96b5b4;>egetkey</span><span>(key_policy, context);
</span><span>    </span><span style=color:#b48ead;>let</span><span> d2 = DeoxysII::new(&seal_key);
</span><span>    seal_key.</span><span style=color:#96b5b4;>zeroize</span><span>();
</span><span>
</span><span>    d2
</span><span>}
</span><span>
</span><span style=color:#65737e;>/// Seal a secret to the enclave.
</span><span style=color:#b48ead;>pub fn </span><span style=color:#8fa1b3;>seal</span><span>(
</span><span>	</span><span style=color:#65737e;>/// MRSIGNER or MRENCLAVE
</span><span>	</span><span style=color:#bf616a;>key_policy</span><span>: Keypolicy,
</span><span>	</span><span style=color:#65737e;>/// The domain separation value
</span><span>	</span><span style=color:#bf616a;>context</span><span>: &[</span><span style=color:#b48ead;>u8</span><span>],
</span><span>	</span><span style=color:#65737e;>/// The plaintext data we want to seal
</span><span>	</span><span style=color:#bf616a;>data</span><span>: &[</span><span style=color:#b48ead;>u8</span><span>],
</span><span>) -> Vec<</span><span style=color:#b48ead;>u8</span><span>> {
</span><span>    </span><span style=color:#b48ead;>let mut</span><span> rng = OsRng {};
</span><span>
</span><span>    </span><span style=color:#b48ead;>let mut</span><span> nonce = [</span><span style=color:#d08770;>0</span><span style=color:#b48ead;>u8</span><span>; </span><span style=color:#d08770;>NONCE_SIZE</span><span>];
</span><span>    rng.</span><span style=color:#96b5b4;>fill</span><span>(&</span><span style=color:#b48ead;>mut</span><span> nonce);
</span><span>    </span><span style=color:#b48ead;>let</span><span> d2 = </span><span style=color:#96b5b4;>new_d2</span><span>(key_policy, context);
</span><span>    </span><span style=color:#b48ead;>let mut</span><span> ciphertext = d2.</span><span style=color:#96b5b4;>seal</span><span>(&nonce, data.</span><span style=color:#96b5b4;>to_vec</span><span>(), vec![]);
</span><span>    ciphertext.</span><span style=color:#96b5b4;>extend_from_slice</span><span>(&nonce);
</span><span>
</span><span>	</span><span style=color:#65737e;>// ciphertext = [ E_k[data] || MAC tag || nonce ]
</span><span>    ciphertext
</span><span>}
</span><span>
</span><span>
</span><span>
</span><span style=color:#65737e;>/// Unseal a previously sealed secret to the enclave.
</span><span style=color:#65737e;>///
</span><span style=color:#65737e;>/// # Panics
</span><span style=color:#65737e;>///
</span><span style=color:#65737e;>/// All parsing and authentication errors of the ciphertext are fatal and
</span><span style=color:#65737e;>/// will result in a panic.
</span><span style=color:#b48ead;>pub fn </span><span style=color:#8fa1b3;>unseal</span><span>(
</span><span>	</span><span style=color:#65737e;>/// MRSIGNER or MRENCLAVE
</span><span>	</span><span style=color:#bf616a;>key_policy</span><span>: Keypolicy,
</span><span>	</span><span style=color:#65737e;>/// The domain separation value
</span><span>	</span><span style=color:#bf616a;>context</span><span>: &[</span><span style=color:#b48ead;>u8</span><span>],
</span><span>	</span><span style=color:#65737e;>/// Previously sealed data
</span><span>	</span><span style=color:#bf616a;>ciphertext</span><span>: &[</span><span style=color:#b48ead;>u8</span><span>],
</span><span>) -> Option&LTVec<</span><span style=color:#b48ead;>u8</span><span>>> {
</span><span>    </span><span style=color:#b48ead;>let</span><span> ct_len = ciphertext.</span><span style=color:#96b5b4;>len</span><span>();
</span><span>    </span><span style=color:#b48ead;>if</span><span> ct_len == </span><span style=color:#d08770;>0 </span><span>{
</span><span>        </span><span style=color:#b48ead;>return </span><span>None;
</span><span>    }
</span><span>    assert!(
</span><span>        ct_len >= </span><span style=color:#d08770;>TAG_SIZE </span><span>+ </span><span style=color:#d08770;>NONCE_SIZE</span><span>,
</span><span>        "</span><span style=color:#a3be8c;>ciphertext is corrupted, invalid size</span><span>"
</span><span>    );
</span><span>    </span><span style=color:#b48ead;>let</span><span> ct_len = ct_len - </span><span style=color:#d08770;>NONCE_SIZE</span><span>;
</span><span>
</span><span>    </span><span style=color:#65737e;>// split: ciphertext = [ E_k[data] || MAC tag || nonce ]
</span><span>    </span><span style=color:#b48ead;>let mut</span><span> nonce = [</span><span style=color:#d08770;>0</span><span style=color:#b48ead;>u8</span><span>; </span><span style=color:#d08770;>NONCE_SIZE</span><span>];
</span><span>    nonce.</span><span style=color:#96b5b4;>copy_from_slice</span><span>(&ciphertext[ct_len..]);
</span><span>    </span><span style=color:#b48ead;>let</span><span> ciphertext = &ciphertext[..ct_len];
</span><span>
</span><span>    </span><span style=color:#b48ead;>let</span><span> d2 = </span><span style=color:#96b5b4;>new_d2</span><span>(key_policy, context);
</span><span>    </span><span style=color:#b48ead;>let</span><span> plaintext = d2
</span><span>        .</span><span style=color:#96b5b4;>open</span><span>(&nonce, ciphertext.</span><span style=color:#96b5b4;>to_vec</span><span>(), vec![])
</span><span>        .</span><span style=color:#96b5b4;>expect</span><span>("</span><span style=color:#a3be8c;>ciphertext is corrupted</span><span>");
</span><span>
</span><span>    Some(plaintext)
</span><span>}
</span></code></pre><h5 id=key-manager-enclaves>Key Manager Enclaves <a aria-label="anchor link" class=anchor-link href=#key-manager-enclaves> # </a></h5><p>They have some <code>keymanager</code> enclave, which appears to manually handle delegating access to individual enclave seal keys.<ul><li>They use <code>MRENCLAVE</code> for each indiviual enclave (so the key is bound to the machine) then the enclave can register the actual key with the <code>keymanager</code> along with a <a href=https://pkg.go.dev/github.com/oasisprotocol/oasis-core/go/keymanager/api#PolicySGX>policy</a> to mediate access more granularly.<li>Their current policy format allows you to explicitly enumerate which enclaves (<code>MRENCLAVE</code> + <code>MRSIGNER</code>) may query private key material and which enclaves may replicate the "master secret" (something consensus related?).</ul></main></div></div></div><form class=d-none id=search-bar><div class=container><div class="row justify-content-center"><div class="col col-lg-11 col-xl-9" id=search-container><input aria-label="Search notes..." class="form-control is-search" placeholder="Search notes..." autocomplete=off id=userinput type=search><div class="shadow rounded" id=suggestions></div></div></div></div></form><script defer src=https://phlip9.com/notes/js/elasticlunr.min.js></script><script defer src=https://phlip9.com/notes/search_index.en.js></script><script defer src=https://phlip9.com/notes/js/search.js></script>