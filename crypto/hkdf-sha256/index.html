<!doctype html><html lang=en-US><head><meta charset=utf-8><meta content="ie=edge" http-equiv=x-ua-compatible><meta content="width=device-width,initial-scale=1,shrink-to-fit=no" name=viewport><link href=https://phlip9.com/notes/main.css rel=stylesheet><meta content="index, follow" name=robots><meta content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1" name=googlebot><meta content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1" name=bingbot><title>hkdf-sha256 | philip's notes</title><meta content="a collection of my notes" name=description><link href=https://phlip9.com/notes/crypto/hkdf-sha256/ rel=canonical><meta content=summary name=twitter:card><meta content=hkdf-sha256 name=twitter:title><meta content=@phlip9 name=twitter:site><meta content=@phlip9 name=twitter:creator><meta content=hkdf-sha256 property=og:title><meta content="a collection of my notes" property=og:description><meta content=article property=og:type><meta content=https://phlip9.com/notes/crypto/hkdf-sha256/ property=og:url><meta content=2024-10-21T04:08:44.982615 property=og:updated_time><meta content="philip's notes" property=og:site_name><meta content=en_US property=og:locale><script type=application/ld+json>
  {
    "@context": "https://schema.org",
    "@type": "Article",
    "mainEntityOfPage": {
      "@type": "WebPage",
      "@id": "/crypto/hkdf-sha256/"
    },
    "headline": "hkdf-sha256",
    "image": ,
    "datePublished": "2022-11-18",
    "dateModified": "2024-10-21",
    "author": {
      "@type": "Person",
      "name": "Philip Hayes"
    },
    "publisher": {
      "@type": "Person",
      "name": "Philip Hayes",
      
    },
    "description": "a collection of my notes"
  }
  </script><script type=application/ld+json>
  {
    "@context": "http://schema.org",
    "@type": "BreadcrumbList",
    
      
      
        
        
        
        
        
        
        
        
          {
            "@type": "ListItem",
            "position":  1 ,
            "name": "Home",
            "item": "https://phlip9.com/notes/"
          },
          
          
          {
            "@type": "ListItem",
            "position":  2 ,
            "name": "Crypto",
            "item": "https://phlip9.com/notes/crypto/"
          },
        
      
        
        
        
        
        
        
        
        
        
        
        
          
          
          {
            "@type": "ListItem",
            "position":  3 ,
            "name": "Hkdf Sha256",
            "item": "https://phlip9.com/notes/crypto/hkdf-sha256/"
          },
        
      
    
  }
</script><meta content=#383866 name=theme-color><link href=https://phlip9.com/notes/apple-touch-icon.png rel=apple-touch-icon sizes=180x180><link href=https://phlip9.com/notes/favicon-32x32.png rel=icon sizes=32x32 type=image/png><link href=https://phlip9.com/notes/favicon-16x16.png rel=icon sizes=16x16 type=image/png><link href=https://phlip9.com/notes/site.webmanifest rel=manifest><script>// https://mathjax.github.io/MathJax-demos-web/convert-configuration/convert-configuration.html
        window.MathJax = {
          tex: {
            inlineMath: [
              ['$', '$']
            ],
            displayMath: [
              ['$$', '$$'],
              ['\\[', '\\]']
            ],
            processEscapes: true,
            processEnvironments: true,
          },
          options: {
            skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
          }
        };</script><script integrity="sha256-z47L98YXVhVIaY0uyDzt675P5Ea+w3RsPh9VD5NuoTY=" async crossorigin=anonymous defer id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3.2.0/es5/tex-chtml.js></script><body class="notes single dark"><div class=container role=document><div class=content><div class="row flex-xl-nowrap"><div class="col-lg-5 col-xl-4 notes-sidebar"><nav aria-label="Main navigation" class=notes-links><a class="navbar-brand link-internal" href=https://phlip9.com/notes/> philip's notes </a><a class="notes-link sidebar-social" href=https://twitter.com/phlip9> <svg class="feather feather-twitter" viewbox="0 0 24 24" fill=none height=20 stroke=currentColor stroke-linecap=round stroke-linejoin=round stroke-width=2 width=20 xmlns=http://www.w3.org/2000/svg><path d="M23 3a10.9 10.9 0 0 1-3.14 1.53 4.48 4.48 0 0 0-7.86 3v1A10.66 10.66 0 0 1 3 4s-4 9 5 13a11.64 11.64 0 0 1-7 2c9 5 20 0 20-11.5a4.5 4.5 0 0 0-.08-.83A7.72 7.72 0 0 0 23 3z"></path></svg> <span class=visually-hidden>Twitter</span> </a><a class="notes-link sidebar-social" href=https://github.com/phlip9> <svg class="feather feather-github" viewbox="0 0 24 24" fill=none height=20 stroke=currentColor stroke-linecap=round stroke-linejoin=round stroke-width=2 width=20 xmlns=http://www.w3.org/2000/svg><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"></path></svg> <span class=visually-hidden>GitHub</span> </a><a class="notes-link sidebar-social" href=# id=sidebar-open-search> <svg aria-labelledby="title desc" viewbox="0 0 19.9 19.7" fill=none height=20 id=search-icon role=img stroke=currentColor stroke-linecap=round stroke-linejoin=round stroke-width=2 tabindex=0 width=20 xmlns=http://www.w3.org/2000/svg> <g class=search-path><path d="M18.5 18.3l-5.4-5.4"></path><circle cx=8 cy=8 r=7></circle> </g> </svg> </a><hr><ol id=sidebar-tree-root><li><input id=sidebar-input-ai-ml type=checkbox> <label class=h3 for=sidebar-input-ai-ml>AI ML</label> <ol><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/AI ML/Expectimax Search/"> Expectimax Search </a><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/AI ML/Markov Decision Process (MDP)/"> Markov Decision Process (MDP) </a></ol><li><input id=sidebar-input-wsl type=checkbox> <label class=h3 for=sidebar-input-wsl>WSL</label> <ol><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/WSL/WSL2 custom kernel/"> WSL2 custom kernel </a></ol><li><li><input id=sidebar-input-android type=checkbox> <label class=h3 for=sidebar-input-android>android</label> <ol><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/android/ADB over TCP inside WSL2/"> ADB over TCP inside WSL2 </a><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/android/OTA updates for rooted android phone/"> OTA updates for rooted android phone </a><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/android/android cli setup/"> android cli setup </a><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/android/building signal-android in WSL2/"> building signal-android in WSL2 </a><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/android/linux ADB udev setup/"> linux ADB udev setup </a><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/android/root phone with magisk/"> root phone with magisk </a></ol><li><input id=sidebar-input-b-i-g-m-o-n-e-y-l-a-w-r-e-g-u-l-a-t-i-o-n type=checkbox> <label class=h3 for=sidebar-input-b-i-g-m-o-n-e-y-l-a-w-r-e-g-u-l-a-t-i-o-n>b i g m o n e y l a w r e g u l a t i o n</label> <ol><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/b i g m o n e y l a w r e g u l a t i o n/financial instituion/"> financial instituion </a><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/b i g m o n e y l a w r e g u l a t i o n/foreign bank account report (FBAR)/"> foreign bank account report (FBAR) </a><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/b i g m o n e y l a w r e g u l a t i o n/monetary instruments/"> monetary instruments </a><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/b i g m o n e y l a w r e g u l a t i o n/money services business (MSB)/"> money services business (MSB) </a></ol><li><input id=sidebar-input-b-l-o-c-k-c-h-a-i-n type=checkbox> <label class=h3 for=sidebar-input-b-l-o-c-k-c-h-a-i-n>b l o c k c h a i n</label> <ol><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/b l o c k c h a i n/aptos/"> aptos </a><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/b l o c k c h a i n/bip158 - compact block filters/"> bip158 - compact block filters </a><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/b l o c k c h a i n/btc utreexo - utxo accumulator/"> btc utreexo - utxo accumulator </a><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/b l o c k c h a i n/fastpay/"> fastpay </a><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/b l o c k c h a i n/oasis/"> oasis </a><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/b l o c k c h a i n/sui/"> sui </a></ol><li><input id=sidebar-input-btc-ln type=checkbox> <label class=h3 for=sidebar-input-btc-ln>btc-ln</label> <ol><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/btc-ln/BOLT 11 - invoices/"> BOLT 11 - invoices </a><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/btc-ln/BOLT 2 - channel management protocol/"> BOLT 2 - channel management protocol </a><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/btc-ln/BOLT 4 - onion routing protocol/"> BOLT 4 - onion routing protocol </a><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/btc-ln/BOLT 7 - p2p node and channel discovery/"> BOLT 7 - p2p node and channel discovery </a><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/btc-ln/BOLT 8 - secure noise transport/"> BOLT 8 - secure noise transport </a><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/btc-ln/atomic multipath payments (AMP)/"> atomic multipath payments (AMP) </a><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/btc-ln/breez lightning service providers/"> breez lightning service providers </a><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/btc-ln/hosted channels/"> hosted channels </a><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/btc-ln/lightning libs/"> lightning libs </a><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/btc-ln/lightning network notes/"> lightning network notes </a><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/btc-ln/lightning rod/"> lightning rod </a><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/btc-ln/lightningdevkit - rust-lightning/"> lightningdevkit - rust-lightning </a><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/btc-ln/submarine swaps/"> submarine swaps </a><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/btc-ln/zero-conf channels/"> zero-conf channels </a></ol><li><input id=sidebar-input-combinatorics type=checkbox> <label class=h3 for=sidebar-input-combinatorics>combinatorics</label> <ol><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/combinatorics/k-combinations of a multiset/"> k-combinations of a multiset </a></ol><li><input id=sidebar-input-confidential-computing type=checkbox> <label class=h3 for=sidebar-input-confidential-computing>confidential computing</label> <ol><li><input id=sidebar-input-confidential-computing-intel-sgx type=checkbox> <label class=h3 for=sidebar-input-confidential-computing-intel-sgx>intel SGX</label> <ol><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/confidential computing/intel SGX/SGX lingo/"> SGX lingo </a><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/confidential computing/intel SGX/overview/"> overview </a><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/confidential computing/intel SGX/remote attestation/"> remote attestation </a><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/confidential computing/intel SGX/sealing/"> sealing </a><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/confidential computing/intel SGX/secure time/"> secure time </a></ol><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/confidential computing/enarx (WASM TEE)/"> enarx (WASM TEE) </a><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/confidential computing/fortanix rust tutorial/"> fortanix rust tutorial </a><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/confidential computing/gramine/"> gramine </a><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/confidential computing/intel TDX/"> intel TDX </a><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/confidential computing/marblerun/"> marblerun </a><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/confidential computing/mystikos/"> mystikos </a><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/confidential computing/remote attestation protocols/"> remote attestation protocols </a></ol><li><input checked id=sidebar-input-crypto type=checkbox> <label class=h3 for=sidebar-input-crypto>crypto</label> <ol><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/crypto/(talk) authenticated data structures for stateless validation/"> (talk) authenticated data structures for stateless validation </a><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/crypto/TLS self-signed pubkey-only certs/"> TLS self-signed pubkey-only certs </a><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/crypto/acme protocol/"> acme protocol </a><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/crypto/biscuit authz/"> biscuit authz </a><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/crypto/dex - open-source OIDC & OAuth 2.0 provider/"> dex - open-source OIDC & OAuth 2.0 provider </a><li class=sidebar-note><a class="notes-link link-internal active" href=https://phlip9.com/notes/crypto/hkdf-sha256/> hkdf-sha256 </a><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/crypto/smallstep - private online CA & ACME server/"> smallstep - private online CA & ACME server </a><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/crypto/tls exported keying material/"> tls exported keying material </a><li class=sidebar-note><a class="notes-link link-internal" href=https://phlip9.com/notes/crypto/zkdocs/> zkdocs </a></ol><li><input id=sidebar-input-design type=checkbox> <label class=h3 for=sidebar-input-design>design</label> <ol><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/design/form design/"> form design </a></ol><li><input id=sidebar-input-devops type=checkbox> <label class=h3 for=sidebar-input-devops>devops</label> <ol><li><input id=sidebar-input-devops-o11y type=checkbox> <label class=h3 for=sidebar-input-devops-o11y>o11y</label> <ol><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/devops/o11y/jaeger oss e2e tracing/"> jaeger oss e2e tracing </a></ol><li><input id=sidebar-input-devops-secrets type=checkbox> <label class=h3 for=sidebar-input-devops-secrets>secrets</label> <ol><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/devops/secrets/1password - secrets automation/"> 1password - secrets automation </a><li class=sidebar-note><a class="notes-link link-internal" href=https://phlip9.com/notes/devops/secrets/doppler/> doppler </a><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/devops/secrets/ejson (Shopify)/"> ejson (Shopify) </a><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/devops/secrets/ejson-kms (AWS)/"> ejson-kms (AWS) </a><li class=sidebar-note><a class="notes-link link-internal" href=https://phlip9.com/notes/devops/secrets/envkey/> envkey </a><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/devops/secrets/fortanix DSM/"> fortanix DSM </a><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/devops/secrets/mozilla SOPS/"> mozilla SOPS </a><li class=sidebar-note><a class="notes-link link-internal" href=https://phlip9.com/notes/devops/secrets/sops-nix/> sops-nix </a><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/devops/secrets/sy - share secrets safely/"> sy - share secrets safely </a></ol><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/devops/AKS - azure kubernetes service/"> AKS - azure kubernetes service </a><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/devops/algo wireguard VPN server/"> algo wireguard VPN server </a><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/devops/azure CLI/"> azure CLI </a><li class=sidebar-note><a class="notes-link link-internal" href=https://phlip9.com/notes/devops/consul/> consul </a><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/devops/deployment strategies/"> deployment strategies </a><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/devops/docker compose/"> docker compose </a><li class=sidebar-note><a class="notes-link link-internal" href=https://phlip9.com/notes/devops/k3s/> k3s </a><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/devops/kind (kubernetes in docker)/"> kind (kubernetes in docker) </a><li class=sidebar-note><a class="notes-link link-internal" href=https://phlip9.com/notes/devops/kubernetes/> kubernetes </a><li class=sidebar-note><a class="notes-link link-internal" href=https://phlip9.com/notes/devops/linkerd/> linkerd </a><li class=sidebar-note><a class="notes-link link-internal" href=https://phlip9.com/notes/devops/minikube/> minikube </a><li class=sidebar-note><a class="notes-link link-internal" href=https://phlip9.com/notes/devops/nomad/> nomad </a><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/devops/service mesh/"> service mesh </a></ol><li><input id=sidebar-input-distributed-systems type=checkbox> <label class=h3 for=sidebar-input-distributed-systems>distributed systems</label> <ol><li><input id=sidebar-input-distributed-systems-papers type=checkbox> <label class=h3 for=sidebar-input-distributed-systems-papers>papers</label> <ol><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/distributed systems/papers/(2020) Semi-Fast Byzantine-tolerant Shared Register without Reliable Broadcast/"> (2020) Semi-Fast Byzantine-tolerant Shared Register without Reliable Broadcast </a><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/distributed systems/papers/(2021) Leaderless Consensus/"> (2021) Leaderless Consensus </a></ol><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/distributed systems/the siren song of backpressure/"> the siren song of backpressure </a></ol><li><input id=sidebar-input-fuzzing type=checkbox> <label class=h3 for=sidebar-input-fuzzing>fuzzing</label> <ol><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/fuzzing/bolero - fuzzing + property testing/"> bolero - fuzzing + property testing </a><li class=sidebar-note><a class="notes-link link-internal" href=https://phlip9.com/notes/fuzzing/fuzzcheck-rs/> fuzzcheck-rs </a><li class=sidebar-note><a class="notes-link link-internal" href=https://phlip9.com/notes/fuzzing/fuzzing/> fuzzing </a></ol><li><input id=sidebar-input-ios type=checkbox> <label class=h3 for=sidebar-input-ios>ios</label> <ol><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/ios/ios setup/"> ios setup </a></ol><li><input id=sidebar-input-keyboards type=checkbox> <label class=h3 for=sidebar-input-keyboards>keyboards</label> <ol><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/keyboards/moergo glove80/"> moergo glove80 </a></ol><li><input id=sidebar-input-lang type=checkbox> <label class=h3 for=sidebar-input-lang>lang</label> <ol><li><input id=sidebar-input-lang-ats type=checkbox> <label class=h3 for=sidebar-input-lang-ats>ATS</label> <ol><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/lang/ATS/ATS2 Notes/"> ATS2 Notes </a><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/lang/ATS/Install ATS2/"> Install ATS2 </a></ol><li><input id=sidebar-input-lang-flutter type=checkbox> <label class=h3 for=sidebar-input-lang-flutter>flutter</label> <ol><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/lang/flutter/dart lang/"> dart lang </a><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/lang/flutter/flutter setup/"> flutter setup </a></ol><li><input id=sidebar-input-lang-rust type=checkbox> <label class=h3 for=sidebar-input-lang-rust>rust</label> <ol><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/lang/rust/optimizing binary size/"> optimizing binary size </a><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/lang/rust/rr with rust/"> rr with rust </a><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/lang/rust/rust verification tools/"> rust verification tools </a><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/lang/rust/rust x SGX/"> rust x SGX </a><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/lang/rust/self-referencing structs/"> self-referencing structs </a><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/lang/rust/sycamore x futures/"> sycamore x futures </a><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/lang/rust/understanding sycamore reactivity/"> understanding sycamore reactivity </a></ol><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/lang/gdb ref/"> gdb ref </a><li class=sidebar-note><a class="notes-link link-internal" href=https://phlip9.com/notes/lang/koka-lang/> koka-lang </a><li class=sidebar-note><a class="notes-link link-internal" href=https://phlip9.com/notes/lang/lua/> lua </a><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/lang/operator fixity and precedence/"> operator fixity and precedence </a></ol><li><input id=sidebar-input-management type=checkbox> <label class=h3 for=sidebar-input-management>management</label> <ol><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/management/relieve often - why generals were more successful in WWII/"> relieve often - why generals were more successful in WWII </a></ol><li><input id=sidebar-input-misc type=checkbox> <label class=h3 for=sidebar-input-misc>misc</label> <ol><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/misc/arm target triples/"> arm target triples </a><li class=sidebar-note><a class="notes-link link-internal" href=https://phlip9.com/notes/misc/envsubst/> envsubst </a><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/misc/git multirepo to monorepo/"> git multirepo to monorepo </a><li class=sidebar-note><a class="notes-link link-internal" href=https://phlip9.com/notes/misc/kintsugi/> kintsugi </a><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/misc/optimization solvers/"> optimization solvers </a><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/misc/pop_OS! tweaks/"> pop_OS! tweaks </a><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/misc/prepping RPI for embedded dev/"> prepping RPI for embedded dev </a><li class=sidebar-note><a class="notes-link link-internal" href=https://phlip9.com/notes/misc/rgbxmas/> rgbxmas </a><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/misc/scanning QR codes on desktop/"> scanning QR codes on desktop </a><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/misc/setting up a headless raspbian boot image/"> setting up a headless raspbian boot image </a><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/misc/uptime to downtime conversion/"> uptime to downtime conversion </a><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/misc/water distillation setup/"> water distillation setup </a></ol><li><input id=sidebar-input-networking type=checkbox> <label class=h3 for=sidebar-input-networking>networking</label> <ol><li class=sidebar-note><a class="notes-link link-internal" href=https://phlip9.com/notes/networking/CIDR/> CIDR </a><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/networking/ipv6 address space/"> ipv6 address space </a><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/networking/network interface card (NIC)/"> network interface card (NIC) </a><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/networking/network interfaces/"> network interfaces </a></ol><li><input id=sidebar-input-nvim type=checkbox> <label class=h3 for=sidebar-input-nvim>nvim</label> <ol><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/nvim/universal-ctags Notes/"> universal-ctags Notes </a></ol><li><input id=sidebar-input-performance type=checkbox> <label class=h3 for=sidebar-input-performance>performance</label> <ol><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/performance/bit hacks/"> bit hacks </a><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/performance/dtrace on macOS/"> dtrace on macOS </a><li class=sidebar-note><a class="notes-link link-internal" href=https://phlip9.com/notes/performance/profiling/> profiling </a><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/performance/simdjson talk/"> simdjson talk </a></ol><li><input id=sidebar-input-postgres type=checkbox> <label class=h3 for=sidebar-input-postgres>postgres</label> <ol><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/postgres/postgres performance tuning/"> postgres performance tuning </a><li class=sidebar-note><a class="notes-link link-internal" href=https://phlip9.com/notes/postgres/snippets/> snippets </a><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/postgres/types of scans/"> types of scans </a></ol><li><input id=sidebar-input-reproducible-builds type=checkbox> <label class=h3 for=sidebar-input-reproducible-builds>reproducible builds</label> <ol><li><input id=sidebar-input-reproducible-builds-nix type=checkbox> <label class=h3 for=sidebar-input-reproducible-builds-nix>nix</label> <ol><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/reproducible builds/nix/links/"> links </a><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/reproducible builds/nix/nix auto-allocate-uids -> nixbld users/"> nix auto-allocate-uids -> nixbld users </a><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/reproducible builds/nix/nix debug broken package build/"> nix debug broken package build </a><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/reproducible builds/nix/nix debug spurrious rebuilds/"> nix debug spurrious rebuilds </a></ol><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/reproducible builds/earthly/"> earthly </a><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/reproducible builds/rebuilderd/"> rebuilderd </a><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/reproducible builds/reproducible-builds.org/"> reproducible-builds.org </a></ol><li><input id=sidebar-input-router type=checkbox> <label class=h3 for=sidebar-input-router>router</label> <ol><li><input id=sidebar-input-router-lightning-router type=checkbox> <label class=h3 for=sidebar-input-router-lightning-router>lightning router</label> <ol><li><input id=sidebar-input-router-lightning-router-captive-portal type=checkbox> <label class=h3 for=sidebar-input-router-lightning-router-captive-portal>captive portal</label> <ol><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/router/lightning router/captive portal/RFC 6585 (Additional HTTP Status Codes)/"> RFC 6585 (Additional HTTP Status Codes) </a><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/router/lightning router/captive portal/arubanetworks captive portal/"> arubanetworks captive portal </a><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/router/lightning router/captive portal/captive portal/"> captive portal </a><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/router/lightning router/captive portal/captive portal (wikipedia)/"> captive portal (wikipedia) </a></ol><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/router/lightning router/lightning router overview/"> lightning router overview </a></ol></ol><li><input id=sidebar-input-statistics-probability type=checkbox> <label class=h3 for=sidebar-input-statistics-probability>statistics probability</label> <ol><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/statistics probability/CDF confidence bands - DKW inequality/"> CDF confidence bands - DKW inequality </a><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/statistics probability/G-test - multinomial goodness-of-fit/"> G-test - multinomial goodness-of-fit </a><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/statistics probability/MAD - median absolute deviation/"> MAD - median absolute deviation </a><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/statistics probability/cheat sheet/"> cheat sheet </a><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/statistics probability/herbie - float error fixer/"> herbie - float error fixer </a><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/statistics probability/kelly criterion + ELO/"> kelly criterion + ELO </a><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/statistics probability/multinomial distribution/"> multinomial distribution </a><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/statistics probability/p-value/"> p-value </a><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/statistics probability/standard error/"> standard error </a><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/statistics probability/testing whether a coin is fair/"> testing whether a coin is fair </a><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/statistics probability/winsorize/"> winsorize </a></ol></ol></nav></div><nav aria-label="Secondary navigation" class="notes-toc d-none d-xl-block col-xl-4"><div class=page-links><h3 class=text-muted>on this page</h3><nav id=table-of-contents><ul><li><a class=link-internal href=https://phlip9.com/notes/crypto/hkdf-sha256/#hkdf-sha256>hkdf-sha256</a> <ul><li><a class=link-internal href=https://phlip9.com/notes/crypto/hkdf-sha256/#usage>usage</a><li><a class=link-internal href=https://phlip9.com/notes/crypto/hkdf-sha256/#definitions>definitions</a> <ul><li><a class=link-internal href=https://phlip9.com/notes/crypto/hkdf-sha256/#sha256>SHA256</a><li><a class=link-internal href=https://phlip9.com/notes/crypto/hkdf-sha256/#hmac-sha256>HMAC-SHA256</a></ul><li><a class=link-internal href=https://phlip9.com/notes/crypto/hkdf-sha256/#hkdf-sha256-1>HKDF-SHA256</a><li><a class=link-internal href=https://phlip9.com/notes/crypto/hkdf-sha256/#rfcs>RFCs</a></ul></ul></nav></div></nav><main class="notes-content tags-content col-lg-11 col-xl-8"><h1 id=hkdf-sha256>hkdf-sha256</h1><p class=text-muted>2022-11-18 · 7 min read<ul class=tags><li><a class="btn btn-outline-primary btn-sm link-internal" href=https://phlip9.com/notes/tags/crypto/>#crypto</a><li><a class="btn btn-outline-primary btn-sm link-internal" href=https://phlip9.com/notes/tags/rust/>#rust</a><li><a class="btn btn-outline-primary btn-sm link-internal" href=https://phlip9.com/notes/tags/tls/>#tls</a></ul><ul><li>HKDF: HMAC-based Key Derivation Function.<li>We'll use a specific hash function (SHA-256) for simplified analysis. You can use any cryptographic hash function, but some constants will need to change to accomodate the different digest block size.<li>Why this page: I keep forgetting perf-relevant details like ideal salt / IKM sizes, or HKDF salt/PRK caching. Seeing all the details laid out flat, with strong types, makes this all clear. As an example, you can save 60-70% on key derivation time if you reuse the intermediate derived <code>Prk</code> when deriving multiple secrets from one common input secret.</ul><h2 id=usage>usage <a aria-label="anchor link" class=anchor-link href=#usage> # </a></h2><pre class=language-rust data-lang=rust style=background-color:#2b303b;color:#c0c5ce;><code class=language-rust data-lang=rust><span style=color:#65737e;>// SALT is usually a static, constant value used for domain
</span><span style=color:#65737e;>// separation.
</span><span style=color:#65737e;>//
</span><span style=color:#65737e;>// Using a unique salt for your application improves the security
</span><span style=color:#65737e;>// bounds on the HKDF. Intuitively, you get a unique PRF just for
</span><span style=color:#65737e;>// your application, rather than a shared PRF used by all the other
</span><span style=color:#65737e;>// default-config'ed users of HKDF-SHA256.
</span><span style=color:#65737e;>//
</span><span style=color:#65737e;>// A constant salt is useful for performance since we can
</span><span style=color:#65737e;>// pre-compute the salted `hkdf::Salt` state.
</span><span style=color:#65737e;>//
</span><span style=color:#65737e;>// I also like to pre-hash the salt, since it guarantees the value
</span><span style=color:#65737e;>// is shorter than the hmac `2 * sha256::BLOCKSIZE` key size
</span><span style=color:#65737e;>// threshold, which mandates an extra hash if exceeded. If your
</span><span style=color:#65737e;>// language supports it, you can even compute this at compile time.
</span><span style=color:#b48ead;>let</span><span> salt: &[</span><span style=color:#b48ead;>u8</span><span>] = sha256::digest(</span><span style=color:#b48ead;>b</span><span>"</span><span style=color:#a3be8c;>MY-DOMAIN-SEPARATION-VALUE</span><span>");
</span><span>
</span><span style=color:#65737e;>// IKM is the input secret
</span><span style=color:#b48ead;>let</span><span> ikm: &[</span><span style=color:#b48ead;>u8</span><span>] = </span><span style=color:#b48ead;>b</span><span>"</span><span style=color:#a3be8c;>MY-SECRET-KEY-MATERIAL</span><span>";
</span><span style=color:#65737e;>// For most cases, think of `infos` as a unqiue label for the
</span><span style=color:#65737e;>// child-secret. You can also bind higher-level application data
</span><span style=color:#65737e;>// like negotiated protocol versions or public keys or other
</span><span style=color:#65737e;>// session-specific data here.
</span><span style=color:#b48ead;>let</span><span> infos: &[&[</span><span style=color:#b48ead;>u8</span><span>]] = &[</span><span style=color:#b48ead;>b</span><span>"</span><span style=color:#a3be8c;>file key</span><span>"];
</span><span style=color:#65737e;>// The length of the output secret. Note that there is a maximum
</span><span style=color:#65737e;>// output length of `255 * BLOCKSIZE` bytes.
</span><span style=color:#b48ead;>let</span><span> output_secret_len: </span><span style=color:#b48ead;>usize </span><span>= </span><span style=color:#d08770;>32</span><span>;
</span><span>
</span><span style=color:#65737e;>// If you just need to derive a few child secrets, just use the
</span><span style=color:#65737e;>// one-line convenience method:
</span><span style=color:#b48ead;>let</span><span> secret = hkdf::derive(salt, ikm, infos, output_secret_len);
</span><span>
</span><span style=color:#65737e;>// Otherwise, at a minimum, consider caching or pre-computing the
</span><span style=color:#65737e;>// salted HKDF(s) used in your application.
</span><span style=color:#65737e;>//
</span><span style=color:#65737e;>// You can then reuse the salted_hkdf multiple times, even with
</span><span style=color:#65737e;>// different root secrets (IKMs).
</span><span style=color:#b48ead;>let</span><span> salted_hkdf = hkdf::Salt::new(salt);
</span><span style=color:#b48ead;>let</span><span> secret1 = salted_hkdf
</span><span>	.</span><span style=color:#96b5b4;>extract</span><span>(ikm1)
</span><span>	.</span><span style=color:#96b5b4;>expand</span><span>(infos, secret_len);
</span><span style=color:#b48ead;>let</span><span> secret2 = salted_hkdf
</span><span>	.</span><span style=color:#96b5b4;>extract</span><span>(ikm2)
</span><span>	.</span><span style=color:#96b5b4;>expand</span><span>(infos, secret_len);
</span><span>
</span><span style=color:#65737e;>// If you use a single input key/secret to derive many child
</span><span style=color:#65737e;>// secrets, reuse the extracted PRK instead of rederiving it each
</span><span style=color:#65737e;>// time:
</span><span style=color:#b48ead;>let</span><span> prk = salted_hkdf.</span><span style=color:#96b5b4;>extract</span><span>(ikm);
</span><span style=color:#b48ead;>let</span><span> secret1 = prk.</span><span style=color:#96b5b4;>expand</span><span>(&[</span><span style=color:#b48ead;>b</span><span>"</span><span style=color:#a3be8c;>file key</span><span>"] </span><span style=color:#65737e;>/* infos */</span><span>, secret_len);
</span><span style=color:#b48ead;>let</span><span> secret2 = prk.</span><span style=color:#96b5b4;>expand</span><span>(&[</span><span style=color:#b48ead;>b</span><span>"</span><span style=color:#a3be8c;>noise key</span><span>"] </span><span style=color:#65737e;>/* infos */</span><span>, secret_len);
</span></code></pre><h2 id=definitions>definitions <a aria-label="anchor link" class=anchor-link href=#definitions> # </a></h2><h3 id=sha256>SHA256 <a aria-label="anchor link" class=anchor-link href=#sha256> # </a></h3><pre class=language-rust data-lang=rust style=background-color:#2b303b;color:#c0c5ce;><code class=language-rust data-lang=rust><span style=color:#b48ead;>mod </span><span>sha256 {
</span><span>	</span><span style=color:#b48ead;>const </span><span style=color:#d08770;>BLOCK_SIZE</span><span>: </span><span style=color:#b48ead;>usize </span><span>= </span><span style=color:#d08770;>32</span><span>;
</span><span>	</span><span style=color:#b48ead;>const </span><span style=color:#d08770;>INTERNAL_BLOCK_SIZE</span><span>: </span><span style=color:#b48ead;>usize </span><span>= </span><span style=color:#d08770;>64</span><span>;
</span><span>
</span><span>	</span><span style=color:#65737e;>/// A finalized SHA-256 hash digest. 32 bytes. 256 bits.
</span><span>	</span><span style=color:#b48ead;>struct </span><span>Hash([</span><span style=color:#b48ead;>u8</span><span>; BLOCK_SIZE]);
</span><span>
</span><span>	</span><span style=color:#65737e;>/// An intermediate SHA-256 digest state.
</span><span>	</span><span style=color:#b48ead;>struct </span><span>Context { </span><span style=color:#65737e;>/* .. */ </span><span>}
</span><span>
</span><span>	</span><span style=color:#b48ead;>impl </span><span>Context {
</span><span>		</span><span style=color:#b48ead;>fn </span><span style=color:#8fa1b3;>new</span><span>() -> </span><span style=color:#b48ead;>Self </span><span>{ </span><span style=color:#65737e;>/* .. */ </span><span>}
</span><span>		</span><span style=color:#b48ead;>fn </span><span style=color:#8fa1b3;>update</span><span>(&</span><span style=color:#b48ead;>mut </span><span style=color:#bf616a;>input</span><span>: &[</span><span style=color:#b48ead;>u8</span><span>]) { </span><span style=color:#65737e;>/* .. */ </span><span>}
</span><span>		</span><span style=color:#b48ead;>fn </span><span style=color:#8fa1b3;>finish</span><span>(</span><span style=color:#bf616a;>self</span><span>) -> sha256::Hash;
</span><span>	}
</span><span>
</span><span>	</span><span style=color:#65737e;>/// A convenience function to easily digest many inputs in
</span><span>	</span><span style=color:#65737e;>/// one line.
</span><span>	</span><span style=color:#b48ead;>fn </span><span style=color:#8fa1b3;>digest</span><span>(</span><span style=color:#bf616a;>inputs</span><span>: &[&[</span><span style=color:#b48ead;>u8</span><span>]]) -> sha256::Hash {
</span><span>		</span><span style=color:#b48ead;>let mut</span><span> ctx = sha256::Context::new();
</span><span>		</span><span style=color:#b48ead;>for</span><span> input in inputs {
</span><span>			ctx.</span><span style=color:#96b5b4;>update</span><span>(input);
</span><span>		}
</span><span>		ctx.</span><span style=color:#96b5b4;>finish</span><span>()
</span><span>	}
</span><span>}
</span></code></pre><h3 id=hmac-sha256>HMAC-SHA256 <a aria-label="anchor link" class=anchor-link href=#hmac-sha256> # </a></h3><pre class=language-rust data-lang=rust style=background-color:#2b303b;color:#c0c5ce;><code class=language-rust data-lang=rust><span style=color:#b48ead;>mod </span><span>hmac {
</span><span>	</span><span style=color:#65737e;>/// A keyed HMAC PRF. Normally this would be used to compute
</span><span>	</span><span style=color:#65737e;>/// MAC tags for message authentication, but HKDFs use this
</span><span>	</span><span style=color:#65737e;>/// a bit differently.
</span><span>	</span><span style=color:#b48ead;>struct </span><span>Context {
</span><span>		</span><span style=color:#65737e;>// IPAD := [0x36; 32]
</span><span>		</span><span style=color:#65737e;>// inner(x) := H(K xor IPAD || x)
</span><span>		</span><span style=color:#bf616a;>inner</span><span>: sha256::Context,
</span><span>		</span><span style=color:#65737e;>// OPAD := [0x5c; 32]
</span><span>		</span><span style=color:#65737e;>// outer(x) := H(K xor OPAD || x)
</span><span>		</span><span style=color:#bf616a;>outer</span><span>: sha256::Context,
</span><span>	}
</span><span>
</span><span>	</span><span style=color:#b48ead;>impl </span><span>Context {
</span><span>		</span><span style=color:#65737e;>/// Create a new keyed HMAC context for digesting multiple
</span><span>		</span><span style=color:#65737e;>/// inputs.
</span><span>		</span><span style=color:#b48ead;>fn </span><span style=color:#8fa1b3;>new</span><span>(</span><span style=color:#bf616a;>key</span><span>: &[</span><span style=color:#b48ead;>u8</span><span>]) -> </span><span style=color:#b48ead;>Self </span><span>{
</span><span>			</span><span style=color:#65737e;>// Keys longer than the internal block size (64 bytes)
</span><span>			</span><span style=color:#65737e;>// must be pre-hashed to make them smaller.
</span><span>			</span><span style=color:#b48ead;>let</span><span> key_hash: sha256::Hash;
</span><span>			</span><span style=color:#b48ead;>let</span><span> key = </span><span style=color:#b48ead;>if</span><span> key.</span><span style=color:#96b5b4;>len</span><span>() > </span><span style=color:#d08770;>64 </span><span>{
</span><span>				key_hash = sha256::digest(&[key]);
</span><span>				key_hash.</span><span style=color:#d08770;>0.</span><span style=color:#96b5b4;>as_slice</span><span>()
</span><span>			} </span><span style=color:#b48ead;>else </span><span>{
</span><span>				key
</span><span>			};
</span><span>
</span><span>			</span><span style=color:#65737e;>// zero-pad key to the internal block size (64 bytes).
</span><span>			</span><span style=color:#b48ead;>let mut</span><span> padded_key = [</span><span style=color:#d08770;>0</span><span style=color:#b48ead;>u8</span><span>; </span><span style=color:#d08770;>64</span><span>];
</span><span>			padded_key[..key.</span><span style=color:#96b5b4;>len</span><span>()].</span><span style=color:#96b5b4;>copy_from_slice</span><span>(key);
</span><span>
</span><span>			</span><span style=color:#65737e;>// ikey := [ key_i ^ 0x36 ]_{i in 0..64}
</span><span>			</span><span style=color:#b48ead;>let mut</span><span> ikey = [</span><span style=color:#d08770;>0x36_</span><span style=color:#b48ead;>u8</span><span>; </span><span style=color:#d08770;>64</span><span>];
</span><span>			</span><span style=color:#b48ead;>for </span><span>(ikey_i, key_i) in ikey.</span><span style=color:#96b5b4;>iter_mut</span><span>().</span><span style=color:#96b5b4;>zip</span><span>(&padded_key) {
</span><span>				*ikey_i ^= key_i;
</span><span>			}
</span><span>
</span><span>			</span><span style=color:#65737e;>// okey := [ key_i ^ 0x5c ]_{i in 0..64}
</span><span>			</span><span style=color:#b48ead;>let mut</span><span> okey = [</span><span style=color:#d08770;>0x5c_</span><span style=color:#b48ead;>u8</span><span>; </span><span style=color:#d08770;>64</span><span>];
</span><span>			</span><span style=color:#b48ead;>for </span><span>(okey_i, key_i) in okey.</span><span style=color:#96b5b4;>iter_mut</span><span>().</span><span style=color:#96b5b4;>zip</span><span>(&padded_key) {
</span><span>				*okey_i ^= key_i;
</span><span>			}
</span><span>
</span><span>			</span><span style=color:#b48ead;>let mut</span><span> hmac_key = </span><span style=color:#b48ead;>Self </span><span>{
</span><span>				inner: sha256::Context::new(),
</span><span>				outer: sha256::Context::new(),
</span><span>			};
</span><span>
</span><span>			hmac_key.inner.</span><span style=color:#96b5b4;>update</span><span>(&ikey);
</span><span>			hmac_key.outer.</span><span style=color:#96b5b4;>update</span><span>(&okey);
</span><span>			hmac_key
</span><span>		}
</span><span>
</span><span>		</span><span style=color:#b48ead;>fn </span><span style=color:#8fa1b3;>update</span><span>(&</span><span style=color:#b48ead;>mut </span><span style=color:#bf616a;>self</span><span>, </span><span style=color:#bf616a;>input</span><span>: &[</span><span style=color:#b48ead;>u8</span><span>]) {
</span><span>			</span><span style=color:#bf616a;>self</span><span>.inner.</span><span style=color:#96b5b4;>update</span><span>(input);
</span><span>		}
</span><span>
</span><span>		</span><span style=color:#b48ead;>fn </span><span style=color:#8fa1b3;>finish</span><span>(</span><span style=color:#b48ead;>mut </span><span style=color:#bf616a;>self</span><span>) -> sha256::Hash {
</span><span>			</span><span style=color:#b48ead;>let</span><span> inner_output = </span><span style=color:#bf616a;>self</span><span>.inner.</span><span style=color:#96b5b4;>finish</span><span>();
</span><span>			</span><span style=color:#bf616a;>self</span><span>.outer.</span><span style=color:#96b5b4;>update</span><span>(&inner_output);
</span><span>			</span><span style=color:#bf616a;>self</span><span>.outer.</span><span style=color:#96b5b4;>finish</span><span>()
</span><span>		}
</span><span>	}
</span><span>
</span><span>	</span><span style=color:#65737e;>/// A convenience function for easily HMAC'ing multiple
</span><span>	</span><span style=color:#65737e;>/// inputs in one line.
</span><span>	</span><span style=color:#b48ead;>fn </span><span style=color:#8fa1b3;>digest</span><span>(</span><span style=color:#bf616a;>key</span><span>: &[</span><span style=color:#b48ead;>u8</span><span>], </span><span style=color:#bf616a;>inputs</span><span>: &[&[</span><span style=color:#b48ead;>u8</span><span>]]) -> sha256::Hash {
</span><span>		</span><span style=color:#b48ead;>let mut</span><span> ctx = hmac::Context::new(key);
</span><span>		</span><span style=color:#b48ead;>for</span><span> input in inputs {
</span><span>			ctx.</span><span style=color:#96b5b4;>update</span><span>(input);
</span><span>		}
</span><span>		ctx.</span><span style=color:#96b5b4;>sign</span><span>()
</span><span>	}
</span><span>}
</span></code></pre><ul><li>Useful perf tips: <ul><li>You can avoid an extra <code>Hash(key)</code> when doing an HMAC so long as the key is no longer than the <em>internal</em> hash block size (e.g., 64 bytes for SHA-256).<li>If a <code>key</code> is fixed for multiple HMAC invocations, you can compute the <code>hmac::Context</code> once and reuse it for multiple <code>hmac::Context::sign</code>'s, avoiding at least 2 hashes and some padding+XORs.</ul></ul><h2 id=hkdf-sha256-1>HKDF-SHA256 <a aria-label="anchor link" class=anchor-link href=#hkdf-sha256-1> # </a></h2><ul><li><strong>Extract</strong> a PRK (Pseudo-Random Key) from IKM (input key material) and domain separator (called salt).<li><strong>Expand</strong> a PRK and label or context into secrets of varying sizes.</ul><pre class=language-rust data-lang=rust style=background-color:#2b303b;color:#c0c5ce;><code class=language-rust data-lang=rust><span style=color:#b48ead;>mod </span><span>hkdf {
</span><span>	</span><span style=color:#65737e;>/// A domain-separated (salted) HKDF context ready to expand
</span><span>	</span><span style=color:#65737e;>/// into an `hkdf::Prk` using some IKM (Input Key Material).
</span><span>	</span><span style=color:#65737e;>///
</span><span>	</span><span style=color:#65737e;>/// `Salt` is (relatively) expensive to construct, so it's
</span><span>	</span><span style=color:#65737e;>/// good to compute once and reuse.
</span><span>	</span><span style=color:#65737e;>///
</span><span>	</span><span style=color:#65737e;>/// `Salt` contains an `hmac::Context`, domain-separated by
</span><span>	</span><span style=color:#65737e;>/// `salt_value`.
</span><span>	</span><span style=color:#65737e;>///
</span><span>	</span><span style=color:#65737e;>/// `Salt.0 := HMAC(salt_value, ___)`
</span><span>	</span><span style=color:#b48ead;>struct </span><span>Salt(hmac::Context);
</span><span>
</span><span>	</span><span style=color:#b48ead;>impl </span><span>Salt {
</span><span>		</span><span style=color:#b48ead;>fn </span><span style=color:#8fa1b3;>new</span><span>(</span><span style=color:#bf616a;>salt_value</span><span>: &[</span><span style=color:#b48ead;>u8</span><span>]) -> </span><span style=color:#b48ead;>Self </span><span>{
</span><span>			</span><span style=color:#b48ead;>Self</span><span>(hmac::Context::new(salt_value))
</span><span>		}
</span><span>
</span><span>		</span><span style=color:#65737e;>/// HKDF-extract a new PRK (keyed HMAC context) from some
</span><span>		</span><span style=color:#65737e;>/// IKM (Input Key Material).
</span><span>		</span><span style=color:#b48ead;>fn </span><span style=color:#8fa1b3;>extract</span><span>(&</span><span style=color:#bf616a;>self</span><span>, </span><span style=color:#bf616a;>ikm</span><span>: &[</span><span style=color:#b48ead;>u8</span><span>]) -> hkdf::Prk {
</span><span>			</span><span style=color:#b48ead;>let mut</span><span> salt_ctx = </span><span style=color:#bf616a;>self</span><span>.</span><span style=color:#d08770;>0.</span><span style=color:#96b5b4;>clone</span><span>();
</span><span>			salt_ctx.</span><span style=color:#96b5b4;>update</span><span>(ikm);
</span><span>			</span><span style=color:#b48ead;>let</span><span> prk = salt_ctx.</span><span style=color:#96b5b4;>finish</span><span>().</span><span style=color:#d08770;>0</span><span>;
</span><span>			hkdf::Prk(hmac::Context::new(&prk))
</span><span>		}
</span><span>	}
</span><span>
</span><span>	</span><span style=color:#65737e;>/// A domain-separated and "extracted" Pseudo-Random Key
</span><span>	</span><span style=color:#65737e;>/// ready to now "expand" into many different child secrets
</span><span>	</span><span style=color:#65737e;>/// of varying lengths.
</span><span>	</span><span style=color:#65737e;>///
</span><span>	</span><span style=color:#65737e;>/// `Prk` is (relatively) expensive to construct, so it's
</span><span>	</span><span style=color:#65737e;>/// good to compute once and reuse.
</span><span>	</span><span style=color:#65737e;>///
</span><span>	</span><span style=color:#65737e;>/// `PRK.0 := HMAC(HMAC(salt, ikm), ___)`
</span><span>	</span><span style=color:#b48ead;>struct </span><span>Prk(hmac::Context);
</span><span>
</span><span>	</span><span style=color:#b48ead;>impl </span><span>Prk {
</span><span>		</span><span style=color:#65737e;>/// HKDF-expand a new secret of `out_len` bytes from a
</span><span>		</span><span style=color:#65737e;>/// `Prk`, using `infos` for domain separation or
</span><span>		</span><span style=color:#65737e;>/// application specific context.
</span><span>		</span><span style=color:#65737e;>///
</span><span>		</span><span style=color:#65737e;>/// For example, from a single root secret, you might
</span><span>		</span><span style=color:#65737e;>/// derive many subkeys simply by using different `infos`
</span><span>		</span><span style=color:#65737e;>/// labels, like "cert key" or "sealing key" or "btc key
</span><span>		</span><span style=color:#65737e;>/// 54".
</span><span>		</span><span style=color:#65737e;>///
</span><span>		</span><span style=color:#65737e;>/// HKDF-SHA256 has a max output secret limit of
</span><span>		</span><span style=color:#65737e;>/// `255 * 32 == 8160` bytes.
</span><span>		</span><span style=color:#b48ead;>fn </span><span style=color:#8fa1b3;>expand</span><span>(&</span><span style=color:#bf616a;>self</span><span>, </span><span style=color:#bf616a;>infos</span><span>: &[&[</span><span style=color:#b48ead;>u8</span><span>]], </span><span style=color:#bf616a;>out_len</span><span>: </span><span style=color:#b48ead;>usize</span><span>) -> Vec<</span><span style=color:#b48ead;>u8</span><span>> {
</span><span>			</span><span style=color:#65737e;>// N is the number of sha256-block-sized blocks we need
</span><span>			</span><span style=color:#65737e;>// to derive in order to cover the desired output length
</span><span>			</span><span style=color:#65737e;>// `out_len`.
</span><span>			</span><span style=color:#65737e;>//
</span><span>			</span><span style=color:#65737e;>// N := ceil(out_len / sha256::BLOCK_SIZE)
</span><span>			</span><span style=color:#65737e;>//   := (out_len.saturating_sub(1) / sha256::BLOCK_SIZE) + 1
</span><span>			</span><span style=color:#b48ead;>let</span><span> n = (out_len.</span><span style=color:#96b5b4;>saturating_sub</span><span>(</span><span style=color:#d08770;>1</span><span>) / </span><span style=color:#d08770;>32</span><span>) + </span><span style=color:#d08770;>1</span><span>;
</span><span>			</span><span style=color:#b48ead;>let</span><span> n = </span><span style=color:#b48ead;>u8</span><span>::try_from(n).</span><span style=color:#96b5b4;>expect</span><span>("</span><span style=color:#a3be8c;>out_len is too large</span><span>");
</span><span>
</span><span>			</span><span style=color:#65737e;>// T      := T(1) || T(2) || .. || T(N)
</span><span>			</span><span style=color:#65737e;>// T(0)   := b"" (empty byte string)
</span><span>			</span><span style=color:#65737e;>// T(i) := hmac::digest(prk, T(i-1) || infos || [ i ])
</span><span>
</span><span>			</span><span style=color:#b48ead;>let mut</span><span> out = Vec::with_capacity(len);
</span><span>			</span><span style=color:#65737e;>// T(i-1)
</span><span>			</span><span style=color:#b48ead;>let mut</span><span> t_im1 = [</span><span style=color:#d08770;>0</span><span style=color:#b48ead;>u8</span><span>; </span><span style=color:#d08770;>32</span><span>];
</span><span>
</span><span>			</span><span style=color:#b48ead;>for</span><span> i in </span><span style=color:#d08770;>1</span><span>..=n {
</span><span>				</span><span style=color:#65737e;>// T(i) := hmac::digest(prk, T(i-1) || infos || [ i ])
</span><span>				</span><span style=color:#b48ead;>let mut</span><span> t_i = {
</span><span>					</span><span style=color:#b48ead;>let mut</span><span> ctx = </span><span style=color:#bf616a;>self</span><span>.</span><span style=color:#d08770;>0.</span><span style=color:#96b5b4;>clone</span><span>();
</span><span>					</span><span style=color:#b48ead;>if</span><span> i != </span><span style=color:#d08770;>1 </span><span>{
</span><span>						ctx.</span><span style=color:#96b5b4;>update</span><span>(&t_im1);
</span><span>					}
</span><span>					</span><span style=color:#b48ead;>for</span><span> info in infos {
</span><span>						ctx.</span><span style=color:#96b5b4;>update</span><span>(info);
</span><span>					}
</span><span>					ctx.</span><span style=color:#96b5b4;>update</span><span>(&[i]);
</span><span>					ctx.</span><span style=color:#96b5b4;>finish</span><span>().</span><span style=color:#d08770;>0
</span><span>				};
</span><span>				t_im1 = t_i;
</span><span>
</span><span>				</span><span style=color:#b48ead;>if</span><span> i < n {
</span><span>					out.</span><span style=color:#96b5b4;>extend_from_slice</span><span>(&t_i[..]);
</span><span>				} </span><span style=color:#b48ead;>else </span><span>{
</span><span>					</span><span style=color:#65737e;>// the last block will need to be truncated if
</span><span>					</span><span style=color:#65737e;>// `out_len` isn't a multiple of the block size.
</span><span>					</span><span style=color:#b48ead;>let</span><span> l = </span><span style=color:#d08770;>32 </span><span>- (((n as </span><span style=color:#b48ead;>usize</span><span>) * </span><span style=color:#d08770;>32</span><span>) - out_len);
</span><span>					out.</span><span style=color:#96b5b4;>extend_from_slice</span><span>(&t_i[..l]);
</span><span>				}
</span><span>			}
</span><span>
</span><span>			out
</span><span>		}
</span><span>	}
</span><span>
</span><span>	</span><span style=color:#65737e;>/// A convenience function to derive a secret of size `out_len`
</span><span>	</span><span style=color:#65737e;>/// from `ikm` (Input Key Material)
</span><span>	</span><span style=color:#b48ead;>fn </span><span style=color:#8fa1b3;>derive</span><span>(
</span><span>		</span><span style=color:#bf616a;>salt</span><span>: &[</span><span style=color:#b48ead;>u8</span><span>],
</span><span>		</span><span style=color:#bf616a;>ikm</span><span>: &[</span><span style=color:#b48ead;>u8</span><span>],
</span><span>		</span><span style=color:#bf616a;>infos</span><span>: &[&[</span><span style=color:#b48ead;>u8</span><span>]],
</span><span>		</span><span style=color:#bf616a;>out_len</span><span>: </span><span style=color:#b48ead;>usize</span><span>,
</span><span>	) -> Vec<</span><span style=color:#b48ead;>u8</span><span>> {
</span><span>		</span><span style=color:#b48ead;>let</span><span> salt = hkdf::Salt::new(salt);
</span><span>		</span><span style=color:#b48ead;>let</span><span> prk = salt.</span><span style=color:#96b5b4;>extract</span><span>(ikm);
</span><span>		prk.</span><span style=color:#96b5b4;>expand</span><span>(infos, out_len)
</span><span>	}
</span><span>}
</span></code></pre><ul><li>Useful perf tips: <ul><li>The <strong>salted HKDF function can be cached</strong>. If you find yourself deriving secrets from multiple different IKMs, this trick may be useful.<li>The <strong>extracted PRK can be cached</strong>. If you find yourself deriving many different secrets from one root secret, this trick may be useful. I've found this trick in particular can <strong>save between 60-70% on key derivation time</strong>.</ul></ul><h2 id=rfcs>RFCs <a aria-label="anchor link" class=anchor-link href=#rfcs> # </a></h2><ul><li><a href=https://www.rfc-editor.org/rfc/rfc2104>RFC 2104: HMAC: Keyed-Hashing for Message Authentication</a><li><a href=https://www.rfc-editor.org/rfc/rfc5869>RFC 5869: HKDF: HMAC-based Extract-and-Expand Key Derivation Function</a></ul></main></div></div></div><form class=d-none id=search-bar><div class=container><div class="row justify-content-center"><div class="col col-lg-11 col-xl-9" id=search-container><input aria-label="Search notes..." class="form-control is-search" placeholder="Search notes..." autocomplete=off id=userinput type=search><div class="shadow rounded" id=suggestions></div></div></div></div></form><script defer src=https://phlip9.com/notes/js/elasticlunr.min.js></script><script defer src=https://phlip9.com/notes/search_index.en.js></script><script defer src=https://phlip9.com/notes/js/search.js></script>