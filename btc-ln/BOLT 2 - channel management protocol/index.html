<!doctype html><html lang=en-US><head><meta charset=utf-8><meta content="ie=edge" http-equiv=x-ua-compatible><meta content="width=device-width,initial-scale=1,shrink-to-fit=no" name=viewport><link href=https://phlip9.com/notes/main.css rel=stylesheet><meta content="index, follow" name=robots><meta content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1" name=googlebot><meta content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1" name=bingbot><title>BOLT 2 - channel management protocol | philip's notes</title><meta content="a collection of my notes" name=description><link href="https://phlip9.com/notes/btc-ln/BOLT 2 - channel management protocol/" rel=canonical><meta content=summary name=twitter:card><meta content="BOLT 2 - channel management protocol" name=twitter:title><meta content=@phlip9 name=twitter:site><meta content=@phlip9 name=twitter:creator><meta content="BOLT 2 - channel management protocol" property=og:title><meta content="a collection of my notes" property=og:description><meta content=article property=og:type><meta content="https://phlip9.com/notes/btc-ln/BOLT 2 - channel management protocol/" property=og:url><meta content=2024-10-21T04:08:44.982615 property=og:updated_time><meta content="philip's notes" property=og:site_name><meta content=en_US property=og:locale><script type=application/ld+json>
  {
    "@context": "https://schema.org",
    "@type": "Article",
    "mainEntityOfPage": {
      "@type": "WebPage",
      "@id": "/btc-ln/BOLT 2 - channel management protocol/"
    },
    "headline": "BOLT 2 - channel management protocol",
    "image": ,
    "datePublished": "2022-04-10",
    "dateModified": "2024-10-21",
    "author": {
      "@type": "Person",
      "name": "Philip Hayes"
    },
    "publisher": {
      "@type": "Person",
      "name": "Philip Hayes",
      
    },
    "description": "a collection of my notes"
  }
  </script><script type=application/ld+json>
  {
    "@context": "http://schema.org",
    "@type": "BreadcrumbList",
    
      
      
        
        
        
        
        
        
        
        
        
        
        
          {
            "@type": "ListItem",
            "position":  1 ,
            "name": "Home",
            "item": "https://phlip9.com/notes/"
          },
          
          
          {
            "@type": "ListItem",
            "position":  2 ,
            "name": "Btc Ln",
            "item": "https://phlip9.com/notes/btc-ln/"
          },
        
      
        
        
        
        
        
        
        
        
        
        
        
          
          
          {
            "@type": "ListItem",
            "position":  3 ,
            "name": "Bolt 2   Channel Management Protocol",
            "item": "https://phlip9.com/notes/btc-ln/BOLT 2 - channel management protocol/"
          },
        
      
    
  }
</script><meta content=#383866 name=theme-color><link href=https://phlip9.com/notes/apple-touch-icon.png rel=apple-touch-icon sizes=180x180><link href=https://phlip9.com/notes/favicon-32x32.png rel=icon sizes=32x32 type=image/png><link href=https://phlip9.com/notes/favicon-16x16.png rel=icon sizes=16x16 type=image/png><link href=https://phlip9.com/notes/site.webmanifest rel=manifest><script>// https://mathjax.github.io/MathJax-demos-web/convert-configuration/convert-configuration.html
        window.MathJax = {
          tex: {
            inlineMath: [
              ['$', '$']
            ],
            displayMath: [
              ['$$', '$$'],
              ['\\[', '\\]']
            ],
            processEscapes: true,
            processEnvironments: true,
          },
          options: {
            skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
          }
        };</script><script integrity="sha256-z47L98YXVhVIaY0uyDzt675P5Ea+w3RsPh9VD5NuoTY=" async crossorigin=anonymous defer id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3.2.0/es5/tex-chtml.js></script><body class="notes single dark"><div class=container role=document><div class=content><div class="row flex-xl-nowrap"><div class="col-lg-5 col-xl-4 notes-sidebar"><nav aria-label="Main navigation" class=notes-links><a class="navbar-brand link-internal" href=https://phlip9.com/notes/> philip's notes </a><a class="notes-link sidebar-social" href=https://twitter.com/phlip9> <svg class="feather feather-twitter" viewbox="0 0 24 24" fill=none height=20 stroke=currentColor stroke-linecap=round stroke-linejoin=round stroke-width=2 width=20 xmlns=http://www.w3.org/2000/svg><path d="M23 3a10.9 10.9 0 0 1-3.14 1.53 4.48 4.48 0 0 0-7.86 3v1A10.66 10.66 0 0 1 3 4s-4 9 5 13a11.64 11.64 0 0 1-7 2c9 5 20 0 20-11.5a4.5 4.5 0 0 0-.08-.83A7.72 7.72 0 0 0 23 3z"></path></svg> <span class=visually-hidden>Twitter</span> </a><a class="notes-link sidebar-social" href=https://github.com/phlip9> <svg class="feather feather-github" viewbox="0 0 24 24" fill=none height=20 stroke=currentColor stroke-linecap=round stroke-linejoin=round stroke-width=2 width=20 xmlns=http://www.w3.org/2000/svg><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"></path></svg> <span class=visually-hidden>GitHub</span> </a><a class="notes-link sidebar-social" href=# id=sidebar-open-search> <svg aria-labelledby="title desc" viewbox="0 0 19.9 19.7" fill=none height=20 id=search-icon role=img stroke=currentColor stroke-linecap=round stroke-linejoin=round stroke-width=2 tabindex=0 width=20 xmlns=http://www.w3.org/2000/svg> <g class=search-path><path d="M18.5 18.3l-5.4-5.4"></path><circle cx=8 cy=8 r=7></circle> </g> </svg> </a><hr><ol id=sidebar-tree-root><li><input id=sidebar-input-ai-ml type=checkbox> <label class=h3 for=sidebar-input-ai-ml>AI ML</label> <ol><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/AI ML/Expectimax Search/"> Expectimax Search </a><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/AI ML/Markov Decision Process (MDP)/"> Markov Decision Process (MDP) </a></ol><li><input id=sidebar-input-wsl type=checkbox> <label class=h3 for=sidebar-input-wsl>WSL</label> <ol><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/WSL/WSL2 custom kernel/"> WSL2 custom kernel </a></ol><li><li><input id=sidebar-input-android type=checkbox> <label class=h3 for=sidebar-input-android>android</label> <ol><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/android/ADB over TCP inside WSL2/"> ADB over TCP inside WSL2 </a><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/android/OTA updates for rooted android phone/"> OTA updates for rooted android phone </a><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/android/android cli setup/"> android cli setup </a><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/android/building signal-android in WSL2/"> building signal-android in WSL2 </a><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/android/linux ADB udev setup/"> linux ADB udev setup </a><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/android/root phone with magisk/"> root phone with magisk </a></ol><li><input id=sidebar-input-b-i-g-m-o-n-e-y-l-a-w-r-e-g-u-l-a-t-i-o-n type=checkbox> <label class=h3 for=sidebar-input-b-i-g-m-o-n-e-y-l-a-w-r-e-g-u-l-a-t-i-o-n>b i g m o n e y l a w r e g u l a t i o n</label> <ol><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/b i g m o n e y l a w r e g u l a t i o n/financial instituion/"> financial instituion </a><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/b i g m o n e y l a w r e g u l a t i o n/foreign bank account report (FBAR)/"> foreign bank account report (FBAR) </a><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/b i g m o n e y l a w r e g u l a t i o n/monetary instruments/"> monetary instruments </a><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/b i g m o n e y l a w r e g u l a t i o n/money services business (MSB)/"> money services business (MSB) </a></ol><li><input id=sidebar-input-b-l-o-c-k-c-h-a-i-n type=checkbox> <label class=h3 for=sidebar-input-b-l-o-c-k-c-h-a-i-n>b l o c k c h a i n</label> <ol><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/b l o c k c h a i n/aptos/"> aptos </a><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/b l o c k c h a i n/bip158 - compact block filters/"> bip158 - compact block filters </a><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/b l o c k c h a i n/btc utreexo - utxo accumulator/"> btc utreexo - utxo accumulator </a><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/b l o c k c h a i n/fastpay/"> fastpay </a><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/b l o c k c h a i n/oasis/"> oasis </a><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/b l o c k c h a i n/sui/"> sui </a></ol><li><input checked id=sidebar-input-btc-ln type=checkbox> <label class=h3 for=sidebar-input-btc-ln>btc-ln</label> <ol><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/btc-ln/BOLT 11 - invoices/"> BOLT 11 - invoices </a><li class=sidebar-note><a class="notes-link link-internal active" href="https://phlip9.com/notes/btc-ln/BOLT 2 - channel management protocol/"> BOLT 2 - channel management protocol </a><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/btc-ln/BOLT 4 - onion routing protocol/"> BOLT 4 - onion routing protocol </a><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/btc-ln/BOLT 7 - p2p node and channel discovery/"> BOLT 7 - p2p node and channel discovery </a><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/btc-ln/BOLT 8 - secure noise transport/"> BOLT 8 - secure noise transport </a><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/btc-ln/atomic multipath payments (AMP)/"> atomic multipath payments (AMP) </a><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/btc-ln/breez lightning service providers/"> breez lightning service providers </a><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/btc-ln/hosted channels/"> hosted channels </a><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/btc-ln/lightning libs/"> lightning libs </a><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/btc-ln/lightning network notes/"> lightning network notes </a><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/btc-ln/lightning rod/"> lightning rod </a><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/btc-ln/lightningdevkit - rust-lightning/"> lightningdevkit - rust-lightning </a><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/btc-ln/submarine swaps/"> submarine swaps </a><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/btc-ln/zero-conf channels/"> zero-conf channels </a></ol><li><input id=sidebar-input-combinatorics type=checkbox> <label class=h3 for=sidebar-input-combinatorics>combinatorics</label> <ol><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/combinatorics/k-combinations of a multiset/"> k-combinations of a multiset </a></ol><li><input id=sidebar-input-confidential-computing type=checkbox> <label class=h3 for=sidebar-input-confidential-computing>confidential computing</label> <ol><li><input id=sidebar-input-confidential-computing-intel-sgx type=checkbox> <label class=h3 for=sidebar-input-confidential-computing-intel-sgx>intel SGX</label> <ol><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/confidential computing/intel SGX/SGX lingo/"> SGX lingo </a><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/confidential computing/intel SGX/overview/"> overview </a><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/confidential computing/intel SGX/remote attestation/"> remote attestation </a><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/confidential computing/intel SGX/sealing/"> sealing </a><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/confidential computing/intel SGX/secure time/"> secure time </a></ol><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/confidential computing/enarx (WASM TEE)/"> enarx (WASM TEE) </a><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/confidential computing/fortanix rust tutorial/"> fortanix rust tutorial </a><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/confidential computing/gramine/"> gramine </a><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/confidential computing/intel TDX/"> intel TDX </a><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/confidential computing/marblerun/"> marblerun </a><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/confidential computing/mystikos/"> mystikos </a><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/confidential computing/remote attestation protocols/"> remote attestation protocols </a></ol><li><input id=sidebar-input-crypto type=checkbox> <label class=h3 for=sidebar-input-crypto>crypto</label> <ol><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/crypto/(talk) authenticated data structures for stateless validation/"> (talk) authenticated data structures for stateless validation </a><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/crypto/TLS self-signed pubkey-only certs/"> TLS self-signed pubkey-only certs </a><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/crypto/acme protocol/"> acme protocol </a><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/crypto/biscuit authz/"> biscuit authz </a><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/crypto/dex - open-source OIDC & OAuth 2.0 provider/"> dex - open-source OIDC & OAuth 2.0 provider </a><li class=sidebar-note><a class="notes-link link-internal" href=https://phlip9.com/notes/crypto/hkdf-sha256/> hkdf-sha256 </a><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/crypto/smallstep - private online CA & ACME server/"> smallstep - private online CA & ACME server </a><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/crypto/tls exported keying material/"> tls exported keying material </a><li class=sidebar-note><a class="notes-link link-internal" href=https://phlip9.com/notes/crypto/zkdocs/> zkdocs </a></ol><li><input id=sidebar-input-design type=checkbox> <label class=h3 for=sidebar-input-design>design</label> <ol><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/design/form design/"> form design </a></ol><li><input id=sidebar-input-devops type=checkbox> <label class=h3 for=sidebar-input-devops>devops</label> <ol><li><input id=sidebar-input-devops-o11y type=checkbox> <label class=h3 for=sidebar-input-devops-o11y>o11y</label> <ol><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/devops/o11y/jaeger oss e2e tracing/"> jaeger oss e2e tracing </a></ol><li><input id=sidebar-input-devops-secrets type=checkbox> <label class=h3 for=sidebar-input-devops-secrets>secrets</label> <ol><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/devops/secrets/1password - secrets automation/"> 1password - secrets automation </a><li class=sidebar-note><a class="notes-link link-internal" href=https://phlip9.com/notes/devops/secrets/doppler/> doppler </a><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/devops/secrets/ejson (Shopify)/"> ejson (Shopify) </a><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/devops/secrets/ejson-kms (AWS)/"> ejson-kms (AWS) </a><li class=sidebar-note><a class="notes-link link-internal" href=https://phlip9.com/notes/devops/secrets/envkey/> envkey </a><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/devops/secrets/fortanix DSM/"> fortanix DSM </a><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/devops/secrets/mozilla SOPS/"> mozilla SOPS </a><li class=sidebar-note><a class="notes-link link-internal" href=https://phlip9.com/notes/devops/secrets/sops-nix/> sops-nix </a><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/devops/secrets/sy - share secrets safely/"> sy - share secrets safely </a></ol><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/devops/AKS - azure kubernetes service/"> AKS - azure kubernetes service </a><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/devops/algo wireguard VPN server/"> algo wireguard VPN server </a><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/devops/azure CLI/"> azure CLI </a><li class=sidebar-note><a class="notes-link link-internal" href=https://phlip9.com/notes/devops/consul/> consul </a><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/devops/deployment strategies/"> deployment strategies </a><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/devops/docker compose/"> docker compose </a><li class=sidebar-note><a class="notes-link link-internal" href=https://phlip9.com/notes/devops/k3s/> k3s </a><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/devops/kind (kubernetes in docker)/"> kind (kubernetes in docker) </a><li class=sidebar-note><a class="notes-link link-internal" href=https://phlip9.com/notes/devops/kubernetes/> kubernetes </a><li class=sidebar-note><a class="notes-link link-internal" href=https://phlip9.com/notes/devops/linkerd/> linkerd </a><li class=sidebar-note><a class="notes-link link-internal" href=https://phlip9.com/notes/devops/minikube/> minikube </a><li class=sidebar-note><a class="notes-link link-internal" href=https://phlip9.com/notes/devops/nomad/> nomad </a><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/devops/service mesh/"> service mesh </a></ol><li><input id=sidebar-input-distributed-systems type=checkbox> <label class=h3 for=sidebar-input-distributed-systems>distributed systems</label> <ol><li><input id=sidebar-input-distributed-systems-papers type=checkbox> <label class=h3 for=sidebar-input-distributed-systems-papers>papers</label> <ol><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/distributed systems/papers/(2020) Semi-Fast Byzantine-tolerant Shared Register without Reliable Broadcast/"> (2020) Semi-Fast Byzantine-tolerant Shared Register without Reliable Broadcast </a><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/distributed systems/papers/(2021) Leaderless Consensus/"> (2021) Leaderless Consensus </a></ol><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/distributed systems/the siren song of backpressure/"> the siren song of backpressure </a></ol><li><input id=sidebar-input-fuzzing type=checkbox> <label class=h3 for=sidebar-input-fuzzing>fuzzing</label> <ol><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/fuzzing/bolero - fuzzing + property testing/"> bolero - fuzzing + property testing </a><li class=sidebar-note><a class="notes-link link-internal" href=https://phlip9.com/notes/fuzzing/fuzzcheck-rs/> fuzzcheck-rs </a><li class=sidebar-note><a class="notes-link link-internal" href=https://phlip9.com/notes/fuzzing/fuzzing/> fuzzing </a></ol><li><input id=sidebar-input-ios type=checkbox> <label class=h3 for=sidebar-input-ios>ios</label> <ol><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/ios/ios setup/"> ios setup </a></ol><li><input id=sidebar-input-keyboards type=checkbox> <label class=h3 for=sidebar-input-keyboards>keyboards</label> <ol><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/keyboards/moergo glove80/"> moergo glove80 </a></ol><li><input id=sidebar-input-lang type=checkbox> <label class=h3 for=sidebar-input-lang>lang</label> <ol><li><input id=sidebar-input-lang-ats type=checkbox> <label class=h3 for=sidebar-input-lang-ats>ATS</label> <ol><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/lang/ATS/ATS2 Notes/"> ATS2 Notes </a><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/lang/ATS/Install ATS2/"> Install ATS2 </a></ol><li><input id=sidebar-input-lang-flutter type=checkbox> <label class=h3 for=sidebar-input-lang-flutter>flutter</label> <ol><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/lang/flutter/dart lang/"> dart lang </a><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/lang/flutter/flutter setup/"> flutter setup </a></ol><li><input id=sidebar-input-lang-rust type=checkbox> <label class=h3 for=sidebar-input-lang-rust>rust</label> <ol><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/lang/rust/optimizing binary size/"> optimizing binary size </a><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/lang/rust/rr with rust/"> rr with rust </a><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/lang/rust/rust verification tools/"> rust verification tools </a><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/lang/rust/rust x SGX/"> rust x SGX </a><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/lang/rust/self-referencing structs/"> self-referencing structs </a><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/lang/rust/sycamore x futures/"> sycamore x futures </a><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/lang/rust/understanding sycamore reactivity/"> understanding sycamore reactivity </a></ol><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/lang/gdb ref/"> gdb ref </a><li class=sidebar-note><a class="notes-link link-internal" href=https://phlip9.com/notes/lang/koka-lang/> koka-lang </a><li class=sidebar-note><a class="notes-link link-internal" href=https://phlip9.com/notes/lang/lua/> lua </a><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/lang/operator fixity and precedence/"> operator fixity and precedence </a></ol><li><input id=sidebar-input-management type=checkbox> <label class=h3 for=sidebar-input-management>management</label> <ol><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/management/relieve often - why generals were more successful in WWII/"> relieve often - why generals were more successful in WWII </a></ol><li><input id=sidebar-input-misc type=checkbox> <label class=h3 for=sidebar-input-misc>misc</label> <ol><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/misc/arm target triples/"> arm target triples </a><li class=sidebar-note><a class="notes-link link-internal" href=https://phlip9.com/notes/misc/envsubst/> envsubst </a><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/misc/git multirepo to monorepo/"> git multirepo to monorepo </a><li class=sidebar-note><a class="notes-link link-internal" href=https://phlip9.com/notes/misc/kintsugi/> kintsugi </a><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/misc/optimization solvers/"> optimization solvers </a><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/misc/pop_OS! tweaks/"> pop_OS! tweaks </a><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/misc/prepping RPI for embedded dev/"> prepping RPI for embedded dev </a><li class=sidebar-note><a class="notes-link link-internal" href=https://phlip9.com/notes/misc/rgbxmas/> rgbxmas </a><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/misc/scanning QR codes on desktop/"> scanning QR codes on desktop </a><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/misc/setting up a headless raspbian boot image/"> setting up a headless raspbian boot image </a><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/misc/uptime to downtime conversion/"> uptime to downtime conversion </a><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/misc/water distillation setup/"> water distillation setup </a></ol><li><input id=sidebar-input-networking type=checkbox> <label class=h3 for=sidebar-input-networking>networking</label> <ol><li class=sidebar-note><a class="notes-link link-internal" href=https://phlip9.com/notes/networking/CIDR/> CIDR </a><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/networking/ipv6 address space/"> ipv6 address space </a><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/networking/network interface card (NIC)/"> network interface card (NIC) </a><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/networking/network interfaces/"> network interfaces </a></ol><li><input id=sidebar-input-nvim type=checkbox> <label class=h3 for=sidebar-input-nvim>nvim</label> <ol><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/nvim/universal-ctags Notes/"> universal-ctags Notes </a></ol><li><input id=sidebar-input-performance type=checkbox> <label class=h3 for=sidebar-input-performance>performance</label> <ol><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/performance/bit hacks/"> bit hacks </a><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/performance/dtrace on macOS/"> dtrace on macOS </a><li class=sidebar-note><a class="notes-link link-internal" href=https://phlip9.com/notes/performance/profiling/> profiling </a><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/performance/simdjson talk/"> simdjson talk </a></ol><li><input id=sidebar-input-postgres type=checkbox> <label class=h3 for=sidebar-input-postgres>postgres</label> <ol><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/postgres/postgres performance tuning/"> postgres performance tuning </a><li class=sidebar-note><a class="notes-link link-internal" href=https://phlip9.com/notes/postgres/snippets/> snippets </a><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/postgres/types of scans/"> types of scans </a></ol><li><input id=sidebar-input-reproducible-builds type=checkbox> <label class=h3 for=sidebar-input-reproducible-builds>reproducible builds</label> <ol><li><input id=sidebar-input-reproducible-builds-nix type=checkbox> <label class=h3 for=sidebar-input-reproducible-builds-nix>nix</label> <ol><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/reproducible builds/nix/links/"> links </a><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/reproducible builds/nix/nix auto-allocate-uids -> nixbld users/"> nix auto-allocate-uids -> nixbld users </a><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/reproducible builds/nix/nix debug broken package build/"> nix debug broken package build </a><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/reproducible builds/nix/nix debug spurrious rebuilds/"> nix debug spurrious rebuilds </a></ol><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/reproducible builds/earthly/"> earthly </a><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/reproducible builds/rebuilderd/"> rebuilderd </a><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/reproducible builds/reproducible-builds.org/"> reproducible-builds.org </a></ol><li><input id=sidebar-input-router type=checkbox> <label class=h3 for=sidebar-input-router>router</label> <ol><li><input id=sidebar-input-router-lightning-router type=checkbox> <label class=h3 for=sidebar-input-router-lightning-router>lightning router</label> <ol><li><input id=sidebar-input-router-lightning-router-captive-portal type=checkbox> <label class=h3 for=sidebar-input-router-lightning-router-captive-portal>captive portal</label> <ol><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/router/lightning router/captive portal/RFC 6585 (Additional HTTP Status Codes)/"> RFC 6585 (Additional HTTP Status Codes) </a><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/router/lightning router/captive portal/arubanetworks captive portal/"> arubanetworks captive portal </a><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/router/lightning router/captive portal/captive portal/"> captive portal </a><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/router/lightning router/captive portal/captive portal (wikipedia)/"> captive portal (wikipedia) </a></ol><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/router/lightning router/lightning router overview/"> lightning router overview </a></ol></ol><li><input id=sidebar-input-statistics-probability type=checkbox> <label class=h3 for=sidebar-input-statistics-probability>statistics probability</label> <ol><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/statistics probability/CDF confidence bands - DKW inequality/"> CDF confidence bands - DKW inequality </a><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/statistics probability/G-test - multinomial goodness-of-fit/"> G-test - multinomial goodness-of-fit </a><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/statistics probability/MAD - median absolute deviation/"> MAD - median absolute deviation </a><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/statistics probability/cheat sheet/"> cheat sheet </a><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/statistics probability/herbie - float error fixer/"> herbie - float error fixer </a><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/statistics probability/kelly criterion + ELO/"> kelly criterion + ELO </a><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/statistics probability/multinomial distribution/"> multinomial distribution </a><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/statistics probability/p-value/"> p-value </a><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/statistics probability/standard error/"> standard error </a><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/statistics probability/testing whether a coin is fair/"> testing whether a coin is fair </a><li class=sidebar-note><a class="notes-link link-internal" href="https://phlip9.com/notes/statistics probability/winsorize/"> winsorize </a></ol></ol></nav></div><nav aria-label="Secondary navigation" class="notes-toc d-none d-xl-block col-xl-4"><div class=page-links><h3 class=text-muted>on this page</h3><nav id=table-of-contents><ul><li><a href="https://phlip9.com/notes/btc-ln/BOLT 2 - channel management protocol/#bolt-2-channel-management-protocol" class=link-internal>BOLT 2 - channel management protocol</a> <ul><li><a href="https://phlip9.com/notes/btc-ln/BOLT 2 - channel management protocol/#def-channel-id-u8-32" class=link-internal>def: channel_id: [u8; 32]</a><li><a href="https://phlip9.com/notes/btc-ln/BOLT 2 - channel management protocol/#channel-establishment" class=link-internal>Channel Establishment</a> <ul><li><a href="https://phlip9.com/notes/btc-ln/BOLT 2 - channel management protocol/#def-open-channel-wire-message" class=link-internal>def: open_channel wire message</a> <ul><li><a href="https://phlip9.com/notes/btc-ln/BOLT 2 - channel management protocol/#funder-flow" class=link-internal>funder flow</a><li><a href="https://phlip9.com/notes/btc-ln/BOLT 2 - channel management protocol/#fundee-flow" class=link-internal>fundee flow</a></ul><li><a href="https://phlip9.com/notes/btc-ln/BOLT 2 - channel management protocol/#def-accept-channel-wire-message" class=link-internal>def: accept_channel wire message</a> <ul><li><a href="https://phlip9.com/notes/btc-ln/BOLT 2 - channel management protocol/#fundee-flow-1" class=link-internal>fundee flow</a><li><a href="https://phlip9.com/notes/btc-ln/BOLT 2 - channel management protocol/#funder-flow-1" class=link-internal>funder flow</a></ul><li><a href="https://phlip9.com/notes/btc-ln/BOLT 2 - channel management protocol/#def-funding-created-wire-message" class=link-internal>def: funding_created wire message</a> <ul><li><a href="https://phlip9.com/notes/btc-ln/BOLT 2 - channel management protocol/#funder-flow-2" class=link-internal>funder flow</a><li><a href="https://phlip9.com/notes/btc-ln/BOLT 2 - channel management protocol/#fundee-flow-2" class=link-internal>fundee flow</a></ul><li><a href="https://phlip9.com/notes/btc-ln/BOLT 2 - channel management protocol/#def-funding-signed-wire-message" class=link-internal>def: funding_signed wire message</a> <ul><li><a href="https://phlip9.com/notes/btc-ln/BOLT 2 - channel management protocol/#fundee-flow-3" class=link-internal>fundee flow</a><li><a href="https://phlip9.com/notes/btc-ln/BOLT 2 - channel management protocol/#funder-flow-3" class=link-internal>funder flow</a></ul><li><a href="https://phlip9.com/notes/btc-ln/BOLT 2 - channel management protocol/#def-funding-locked-wire-message" class=link-internal>def: funding_locked wire message</a> <ul><li><a href="https://phlip9.com/notes/btc-ln/BOLT 2 - channel management protocol/#funder-fundee-flow" class=link-internal>funder & fundee flow</a></ul></ul><li><a href="https://phlip9.com/notes/btc-ln/BOLT 2 - channel management protocol/#cooperative-channel-close" class=link-internal>Cooperative Channel Close</a> <ul><li><a href="https://phlip9.com/notes/btc-ln/BOLT 2 - channel management protocol/#def-shutdown-wire-message" class=link-internal>def: shutdown wire message</a> <ul><li><a href="https://phlip9.com/notes/btc-ln/BOLT 2 - channel management protocol/#active-closer" class=link-internal>active closer</a><li><a href="https://phlip9.com/notes/btc-ln/BOLT 2 - channel management protocol/#passive-closer" class=link-internal>passive closer</a></ul><li><a href="https://phlip9.com/notes/btc-ln/BOLT 2 - channel management protocol/#def-closing-signed-wire-message" class=link-internal>def: closing_signed wire message</a></ul><li><a href="https://phlip9.com/notes/btc-ln/BOLT 2 - channel management protocol/#normal-channel-operation" class=link-internal>Normal Channel Operation</a> <ul><li><a href="https://phlip9.com/notes/btc-ln/BOLT 2 - channel management protocol/#def-update-add-htlc-wire-message" class=link-internal>def: update_add_htlc wire message</a></ul></ul></ul></nav></div></nav><main class="notes-content tags-content col-lg-11 col-xl-8"><h1 id=bolt-2-channel-management-protocol>BOLT 2 - channel management protocol</h1><p class=text-muted>2022-04-10 · 14 min read<ul class=tags><li><a class="btn btn-outline-primary btn-sm link-internal" href=https://phlip9.com/notes/tags/lightning/>#lightning</a></ul><p>Source: <a href=https://github.com/lightning/bolts/blob/master/02-peer-protocol.md>https://github.com/lightning/bolts/blob/master/02-peer-protocol.md</a><p>This BOLT describes the bilateral messaging protocol for (1) establishing, (2) operating, and (3) closing lightning payment channels between two LN peers.<h2 id=def-channel-id-u8-32>def: <code>channel_id: [u8; 32]</code> <a aria-label="anchor link" class=anchor-link href=#def-channel-id-u8-32> # </a></h2><p>Channels are identified by a <code>channel_id</code>, which is <a href=https://github.com/lightningdevkit/rust-lightning/blob/711bcefbcc0999543d9622c030ff7dc8118fc26f/lightning/src/chain/transaction.rs#L60>derived from the funding tx id and index</a>.<p>Before the channel is funded, the <a href=https://github.com/lightningdevkit/rust-lightning/blob/711bcefbcc0999543d9622c030ff7dc8118fc26f/lightning/src/ln/channel.rs#L894><code>channel_id</code> is random</a>.<p>Pre-funded channels are not yet uniquely identified. Use <code>(src_node_id, dest_node_id, channel_id)</code> for identification.<p>Parties can also offer "short channel id" (SCID) aliases (size = <code>u64</code>), which we can use instead of the actual <code>channel_id</code> to avoid leaking the on-chain funding UTXO.<h2 id=channel-establishment>Channel Establishment <a aria-label="anchor link" class=anchor-link href=#channel-establishment> # </a></h2><p>Channels may be established after a secure connection is <a href=https://phlip9.com/notes/btc-ln/BOLT%208%20-%20secure%20noise%20transport/>authenticated</a> and <a href=https://github.com/lightning/bolts/blob/master/01-messaging.md#the-init-message>features negotiated</a>.<p>The establishment process goes through 3 phases: (1-2) negotiate the channel parameters, (3-4) create the funding tx, (5-6) lock in the channel once the funding tx is confirmed on-chain.<pre style=background-color:#2b303b;color:#c0c5ce;><code><span> funder                                 fundee
</span><span>+-------+                              +-------+
</span><span>|       |--(1)---  open_channel  ----->|       |  <
</span><span>|       |&LT-(2)--  accept_channel  -----|       |  <
</span><span>|       |                              |       |  <  temporary channel id
</span><span>|   A   |--(3)--  funding_created  --->|   B   |  <
</span><span>|       |&LT-(4)--  funding_signed  -----|       |  <
</span><span>|       |                              |       | ---
</span><span>|       |--(5)--- funding_locked  ---->|       |  <
</span><span>|       |&LT-(6)--- funding_locked  -----|       |  <  real channel id
</span><span>+-------+                              +-------+  <
</span></code></pre><h3 id=def-open-channel-wire-message>def: <code>open_channel</code> wire message <a aria-label="anchor link" class=anchor-link href=#def-open-channel-wire-message> # </a></h3><p>The channel funder sends an <code>open_channel</code> message to the channel fundee. Here, funder and fundee are negotiating the channel parameters for their new channel contract. A few of the important channel parameters:<ol><li>the channel size (amount to be funded or max liquidity)<li>optional initial payment to fundee<li>channel fee rate<li>supported channel features<li>bounds: minimum HTLC size, dust limits, max num. HTLCs, max in-flight value<li>on-chain confirmations-to-finality</ol><p>The channel id is just a random nonce at this point.<p>See: <a href=https://github.com/lightningdevkit/rust-lightning/blob/711bcefbcc0999543d9622c030ff7dc8118fc26f/lightning/src/ln/msgs.rs#L134><code>msgs::OpenChannel</code></a><pre class=language-rust data-lang=rust style=background-color:#2b303b;color:#c0c5ce;><code class=language-rust data-lang=rust><span style=color:#65737e;>/// An open_channel message to be sent or received from a peer
</span><span style=color:#b48ead;>pub struct </span><span>OpenChannel {
</span><span>	</span><span style=color:#65737e;>/// The genesis hash of the blockchain where the channel is to be opened
</span><span>	</span><span style=color:#b48ead;>pub </span><span style=color:#bf616a;>chain_hash</span><span>: BlockHash,
</span><span>	</span><span style=color:#65737e;>/// A temporary channel ID, until the funding outpoint is announced
</span><span>	</span><span style=color:#b48ead;>pub </span><span style=color:#bf616a;>temporary_channel_id</span><span>: [</span><span style=color:#b48ead;>u8</span><span>; 32],
</span><span>	</span><span style=color:#65737e;>/// The channel value
</span><span>	</span><span style=color:#b48ead;>pub </span><span style=color:#bf616a;>funding_satoshis</span><span>: </span><span style=color:#b48ead;>u64</span><span>,
</span><span>	</span><span style=color:#65737e;>/// The amount to push to the counterparty as part of the open, in
</span><span>	</span><span style=color:#65737e;>/// milli-satoshi
</span><span>	</span><span style=color:#b48ead;>pub </span><span style=color:#bf616a;>push_msat</span><span>: </span><span style=color:#b48ead;>u64</span><span>,
</span><span>	</span><span style=color:#65737e;>/// The threshold below which outputs on transactions broadcast by
</span><span>	</span><span style=color:#65737e;>/// sender will be omitted
</span><span>	</span><span style=color:#b48ead;>pub </span><span style=color:#bf616a;>dust_limit_satoshis</span><span>: </span><span style=color:#b48ead;>u64</span><span>,
</span><span>	</span><span style=color:#65737e;>/// The maximum inbound HTLC value in flight towards sender, in
</span><span>	</span><span style=color:#65737e;>/// milli-satoshi
</span><span>	</span><span style=color:#b48ead;>pub </span><span style=color:#bf616a;>max_htlc_value_in_flight_msat</span><span>: </span><span style=color:#b48ead;>u64</span><span>,
</span><span>	</span><span style=color:#65737e;>/// The minimum value unencumbered by HTLCs for the counterparty
</span><span>	</span><span style=color:#65737e;>/// to keep in the channel
</span><span>	</span><span style=color:#b48ead;>pub </span><span style=color:#bf616a;>channel_reserve_satoshis</span><span>: </span><span style=color:#b48ead;>u64</span><span>,
</span><span>	</span><span style=color:#65737e;>/// The minimum HTLC size incoming to sender, in milli-satoshi
</span><span>	</span><span style=color:#b48ead;>pub </span><span style=color:#bf616a;>htlc_minimum_msat</span><span>: </span><span style=color:#b48ead;>u64</span><span>,
</span><span>	</span><span style=color:#65737e;>/// The feerate per 1000-weight of sender generated transactions,
</span><span>	</span><span style=color:#65737e;>/// until updated by update_fee
</span><span>	</span><span style=color:#b48ead;>pub </span><span style=color:#bf616a;>feerate_per_kw</span><span>: </span><span style=color:#b48ead;>u32</span><span>,
</span><span>	</span><span style=color:#65737e;>/// The number of blocks which the counterparty will have to wait
</span><span>	</span><span style=color:#65737e;>/// to claim on-chain funds if they broadcast a commitment transaction
</span><span>	</span><span style=color:#b48ead;>pub </span><span style=color:#bf616a;>to_self_delay</span><span>: </span><span style=color:#b48ead;>u16</span><span>,
</span><span>	</span><span style=color:#65737e;>/// The maximum number of inbound HTLCs towards sender
</span><span>	</span><span style=color:#b48ead;>pub </span><span style=color:#bf616a;>max_accepted_htlcs</span><span>: </span><span style=color:#b48ead;>u16</span><span>,
</span><span>	</span><span style=color:#65737e;>/// The sender's key controlling the funding transaction
</span><span>	</span><span style=color:#b48ead;>pub </span><span style=color:#bf616a;>funding_pubkey</span><span>: PublicKey,
</span><span>	</span><span style=color:#65737e;>/// Used to derive a revocation key for transactions broadcast
</span><span>	</span><span style=color:#65737e;>/// by counterparty
</span><span>	</span><span style=color:#b48ead;>pub </span><span style=color:#bf616a;>revocation_basepoint</span><span>: PublicKey,
</span><span>	</span><span style=color:#65737e;>/// A payment key to sender for transactions broadcast by counterparty
</span><span>	</span><span style=color:#b48ead;>pub </span><span style=color:#bf616a;>payment_point</span><span>: PublicKey,
</span><span>	</span><span style=color:#65737e;>/// Used to derive a payment key to sender for transactions
</span><span>	</span><span style=color:#65737e;>/// broadcast by sender
</span><span>	</span><span style=color:#b48ead;>pub </span><span style=color:#bf616a;>delayed_payment_basepoint</span><span>: PublicKey,
</span><span>	</span><span style=color:#65737e;>/// Used to derive an HTLC payment key to sender
</span><span>	</span><span style=color:#b48ead;>pub </span><span style=color:#bf616a;>htlc_basepoint</span><span>: PublicKey,
</span><span>	</span><span style=color:#65737e;>/// The first to-be-broadcast-by-sender transaction's per
</span><span>	</span><span style=color:#65737e;>/// commitment point
</span><span>	</span><span style=color:#b48ead;>pub </span><span style=color:#bf616a;>first_per_commitment_point</span><span>: PublicKey,
</span><span>	</span><span style=color:#65737e;>/// Channel flags
</span><span>	</span><span style=color:#b48ead;>pub </span><span style=color:#bf616a;>channel_flags</span><span>: </span><span style=color:#b48ead;>u8</span><span>,
</span><span>	</span><span style=color:#65737e;>/// Optionally, a request to pre-set the to-sender output's
</span><span>	</span><span style=color:#65737e;>/// scriptPubkey for when we collaboratively close
</span><span>	</span><span style=color:#b48ead;>pub </span><span style=color:#bf616a;>shutdown_scriptpubkey</span><span>: OptionalField&LTScript>,
</span><span>	</span><span style=color:#65737e;>/// The channel type that this channel will represent. If none is
</span><span>	</span><span style=color:#65737e;>/// set, we derive the channel type from the intersection of our
</span><span>	</span><span style=color:#65737e;>/// feature bits with our counterparty's feature bits from the
</span><span>	</span><span style=color:#65737e;>/// Init message.
</span><span>	</span><span style=color:#b48ead;>pub </span><span style=color:#bf616a;>channel_type</span><span>: Option&LTChannelTypeFeatures>,
</span><span>}
</span></code></pre><h4 id=funder-flow>funder flow <a aria-label="anchor link" class=anchor-link href=#funder-flow> # </a></h4><p><a href=https://github.com/lightningdevkit/rust-lightning/blob/711bcefbcc0999543d9622c030ff7dc8118fc26f/lightning/src/ln/channelmanager.rs#L1874><code>ChannelManager::create_channel</code></a><h4 id=fundee-flow>fundee flow <a aria-label="anchor link" class=anchor-link href=#fundee-flow> # </a></h4><p><a href=https://github.com/lightningdevkit/rust-lightning/blob/711bcefbcc0999543d9622c030ff7dc8118fc26f/lightning/src/ln/channelmanager.rs#L4385><code>ChannelManager::internal_open_channel</code></a><p><a href=https://github.com/lightningdevkit/rust-lightning/blob/711bcefbcc0999543d9622c030ff7dc8118fc26f/lightning/src/ln/channel.rs#L4785><code>Channel::accept_inbound_channel</code></a><p>(If configured for user-level authorization) Generate <a href=https://github.com/lightningdevkit/rust-lightning/blob/711bcefbcc0999543d9622c030ff7dc8118fc26f/lightning/src/util/events.rs#L421><code>Event::OpenChannelRequest</code></a><h3 id=def-accept-channel-wire-message>def: <code>accept_channel</code> wire message <a aria-label="anchor link" class=anchor-link href=#def-accept-channel-wire-message> # </a></h3><p>The fundee can choose to accept a new channel proposal by responding with an <code>accept_channel</code> message.<p>The channel id is still the same random nonce.<p>See: <a href=https://github.com/lightningdevkit/rust-lightning/blob/711bcefbcc0999543d9622c030ff7dc8118fc26f/lightning/src/ln/msgs.rs#L181>https://github.com/lightningdevkit/rust-lightning/blob/711bcefbcc0999543d9622c030ff7dc8118fc26f/lightning/src/ln/msgs.rs#L181</a><pre class=language-rust data-lang=rust style=background-color:#2b303b;color:#c0c5ce;><code class=language-rust data-lang=rust><span style=color:#65737e;>/// An accept_channel message to be sent or received from a peer
</span><span style=color:#b48ead;>pub struct </span><span>AcceptChannel {
</span><span>	</span><span style=color:#65737e;>/// A temporary channel ID, until the funding outpoint is announced
</span><span>	</span><span style=color:#b48ead;>pub </span><span style=color:#bf616a;>temporary_channel_id</span><span>: [</span><span style=color:#b48ead;>u8</span><span>; 32],
</span><span>	</span><span style=color:#65737e;>/// The threshold below which outputs on transactions broadcast
</span><span>	</span><span style=color:#65737e;>/// by sender will be omitted
</span><span>	</span><span style=color:#b48ead;>pub </span><span style=color:#bf616a;>dust_limit_satoshis</span><span>: </span><span style=color:#b48ead;>u64</span><span>,
</span><span>	</span><span style=color:#65737e;>/// The maximum inbound HTLC value in flight towards sender,
</span><span>	</span><span style=color:#65737e;>/// in milli-satoshi
</span><span>	</span><span style=color:#b48ead;>pub </span><span style=color:#bf616a;>max_htlc_value_in_flight_msat</span><span>: </span><span style=color:#b48ead;>u64</span><span>,
</span><span>	</span><span style=color:#65737e;>/// The minimum value unencumbered by HTLCs for the counterparty
</span><span>	</span><span style=color:#65737e;>/// to keep in the channel
</span><span>	</span><span style=color:#b48ead;>pub </span><span style=color:#bf616a;>channel_reserve_satoshis</span><span>: </span><span style=color:#b48ead;>u64</span><span>,
</span><span>	</span><span style=color:#65737e;>/// The minimum HTLC size incoming to sender, in milli-satoshi
</span><span>	</span><span style=color:#b48ead;>pub </span><span style=color:#bf616a;>htlc_minimum_msat</span><span>: </span><span style=color:#b48ead;>u64</span><span>,
</span><span>	</span><span style=color:#65737e;>/// Minimum depth of the funding transaction before the channel
</span><span>	</span><span style=color:#65737e;>/// is considered open
</span><span>	</span><span style=color:#b48ead;>pub </span><span style=color:#bf616a;>minimum_depth</span><span>: </span><span style=color:#b48ead;>u32</span><span>,
</span><span>	</span><span style=color:#65737e;>/// The number of blocks which the counterparty will have to wait
</span><span>	</span><span style=color:#65737e;>/// to claim on-chain funds if they broadcast a commitment transaction
</span><span>	</span><span style=color:#b48ead;>pub </span><span style=color:#bf616a;>to_self_delay</span><span>: </span><span style=color:#b48ead;>u16</span><span>,
</span><span>	</span><span style=color:#65737e;>/// The maximum number of inbound HTLCs towards sender
</span><span>	</span><span style=color:#b48ead;>pub </span><span style=color:#bf616a;>max_accepted_htlcs</span><span>: </span><span style=color:#b48ead;>u16</span><span>,
</span><span>	</span><span style=color:#65737e;>/// The sender's key controlling the funding transaction
</span><span>	</span><span style=color:#b48ead;>pub </span><span style=color:#bf616a;>funding_pubkey</span><span>: PublicKey,
</span><span>	</span><span style=color:#65737e;>/// Used to derive a revocation key for transactions broadcast
</span><span>	</span><span style=color:#65737e;>/// by counterparty
</span><span>	</span><span style=color:#b48ead;>pub </span><span style=color:#bf616a;>revocation_basepoint</span><span>: PublicKey,
</span><span>	</span><span style=color:#65737e;>/// A payment key to sender for transactions broadcast by counterparty
</span><span>	</span><span style=color:#b48ead;>pub </span><span style=color:#bf616a;>payment_point</span><span>: PublicKey,
</span><span>	</span><span style=color:#65737e;>/// Used to derive a payment key to sender for transactions
</span><span>	</span><span style=color:#65737e;>/// broadcast by sender
</span><span>	</span><span style=color:#b48ead;>pub </span><span style=color:#bf616a;>delayed_payment_basepoint</span><span>: PublicKey,
</span><span>	</span><span style=color:#65737e;>/// Used to derive an HTLC payment key to sender for transactions
</span><span>	</span><span style=color:#65737e;>/// broadcast by counterparty
</span><span>	</span><span style=color:#b48ead;>pub </span><span style=color:#bf616a;>htlc_basepoint</span><span>: PublicKey,
</span><span>	</span><span style=color:#65737e;>/// The first to-be-broadcast-by-sender transaction's per
</span><span>	</span><span style=color:#65737e;>/// commitment point
</span><span>	</span><span style=color:#b48ead;>pub </span><span style=color:#bf616a;>first_per_commitment_point</span><span>: PublicKey,
</span><span>	</span><span style=color:#65737e;>/// Optionally, a request to pre-set the to-sender output's
</span><span>	</span><span style=color:#65737e;>/// scriptPubkey for when we collaboratively close
</span><span>	</span><span style=color:#b48ead;>pub </span><span style=color:#bf616a;>shutdown_scriptpubkey</span><span>: OptionalField&LTScript>,
</span><span>	</span><span style=color:#65737e;>/// The channel type that this channel will represent. If none is
</span><span>	</span><span style=color:#65737e;>/// set, we derive the channel type from the intersection of our
</span><span>	</span><span style=color:#65737e;>/// feature bits with our counterparty's feature bits from the
</span><span>	</span><span style=color:#65737e;>/// Init message.
</span><span>	</span><span style=color:#65737e;>///
</span><span>	</span><span style=color:#65737e;>/// This is required to match the equivalent field in
</span><span>	</span><span style=color:#65737e;>/// [`OpenChannel::channel_type`].
</span><span>	</span><span style=color:#b48ead;>pub </span><span style=color:#bf616a;>channel_type</span><span>: Option&LTChannelTypeFeatures>,
</span><span>}
</span></code></pre><h4 id=fundee-flow-1>fundee flow <a aria-label="anchor link" class=anchor-link href=#fundee-flow-1> # </a></h4><p>If accept: <a href=https://github.com/lightningdevkit/rust-lightning/blob/711bcefbcc0999543d9622c030ff7dc8118fc26f/lightning/src/ln/channel.rs#L4810><code>Channel::generate_accept_channel_message</code></a><h4 id=funder-flow-1>funder flow <a aria-label="anchor link" class=anchor-link href=#funder-flow-1> # </a></h4><p><a href=https://github.com/lightningdevkit/rust-lightning/blob/711bcefbcc0999543d9622c030ff7dc8118fc26f/lightning/src/ln/channel.rs#L4810><code>ChannelManager::internal_accept_channel</code></a><p><a href=https://github.com/lightningdevkit/rust-lightning/blob/711bcefbcc0999543d9622c030ff7dc8118fc26f/lightning/src/ln/channel.rs#L1888><code>Channel::accept_channel</code></a><p>Generate <a href=https://github.com/lightningdevkit/rust-lightning/blob/711bcefbcc0999543d9622c030ff7dc8118fc26f/lightning/src/util/events.rs#L163><code>Event::FundingGenerationReady</code></a><h3 id=def-funding-created-wire-message>def: <code>funding_created</code> wire message <a aria-label="anchor link" class=anchor-link href=#def-funding-created-wire-message> # </a></h3><p>The funder crafts a funding transaction, signs it, and sends it to the fundee for their signature.<p>The channel id is still a random nonce.<p>See: <a href=https://github.com/lightningdevkit/rust-lightning/blob/711bcefbcc0999543d9622c030ff7dc8118fc26f/lightning/src/ln/msgs.rs#L222>https://github.com/lightningdevkit/rust-lightning/blob/711bcefbcc0999543d9622c030ff7dc8118fc26f/lightning/src/ln/msgs.rs#L222</a><pre class=language-rust data-lang=rust style=background-color:#2b303b;color:#c0c5ce;><code class=language-rust data-lang=rust><span style=color:#65737e;>/// A funding_created message to be sent or received from a peer
</span><span style=color:#b48ead;>pub struct </span><span>FundingCreated {
</span><span>	</span><span style=color:#65737e;>/// A temporary channel ID, until the funding is established
</span><span>	</span><span style=color:#b48ead;>pub </span><span style=color:#bf616a;>temporary_channel_id</span><span>: [</span><span style=color:#b48ead;>u8</span><span>; 32],
</span><span>	</span><span style=color:#65737e;>/// The funding transaction ID
</span><span>	</span><span style=color:#b48ead;>pub </span><span style=color:#bf616a;>funding_txid</span><span>: Txid,
</span><span>	</span><span style=color:#65737e;>/// The specific output index funding this channel
</span><span>	</span><span style=color:#b48ead;>pub </span><span style=color:#bf616a;>funding_output_index</span><span>: </span><span style=color:#b48ead;>u16</span><span>,
</span><span>	</span><span style=color:#65737e;>/// The signature of the channel initiator (funder) on the
</span><span>	</span><span style=color:#65737e;>/// initial commitment transaction
</span><span>	</span><span style=color:#b48ead;>pub </span><span style=color:#bf616a;>signature</span><span>: Signature,
</span><span>}
</span></code></pre><h4 id=funder-flow-2>funder flow <a aria-label="anchor link" class=anchor-link href=#funder-flow-2> # </a></h4><p><a href=https://github.com/lightningdevkit/rust-lightning/blob/711bcefbcc0999543d9622c030ff7dc8118fc26f/lightning/src/util/events.rs#L163><code>ChannelManager::funding_transaction_generated</code></a><p><a href=https://github.com/lightningdevkit/rust-lightning/blob/711bcefbcc0999543d9622c030ff7dc8118fc26f/lightning/src/ln/channelmanager.rs#L2930><code>ChannelManager::funding_transaction_generated_intern</code></a><p>Updates the channel state and creates the <code>FundingCreated</code> p2p msg: <a href=https://github.com/lightningdevkit/rust-lightning/blob/711bcefbcc0999543d9622c030ff7dc8118fc26f/lightning/src/ln/channel.rs#L4861><code>Channel::get_outbound_funding_created</code></a><h4 id=fundee-flow-2>fundee flow <a aria-label="anchor link" class=anchor-link href=#fundee-flow-2> # </a></h4><p><a href=https://github.com/lightningdevkit/rust-lightning/blob/711bcefbcc0999543d9622c030ff7dc8118fc26f/lightning/src/ln/channel.rs#L4861><code>ChannelManager::internal_funding_created</code></a><p>Fundee verifies, signs, returns <code>FundingSigned</code> msg: <a href=https://github.com/lightningdevkit/rust-lightning/blob/711bcefbcc0999543d9622c030ff7dc8118fc26f/lightning/src/ln/channel.rs#L4861><code>Channel::funding_created</code></a><p>Fundee finally signs here: <a href=https://github.com/lightningdevkit/rust-lightning/blob/711bcefbcc0999543d9622c030ff7dc8118fc26f/lightning/src/ln/channel.rs#L2010><code>Channel::funding_created_signature</code></a><p>Fundee adds channel monitor hook to watch for confirmations. Responds with <code>FundingSigned</code> message.<h3 id=def-funding-signed-wire-message>def: <code>funding_signed</code> wire message <a aria-label="anchor link" class=anchor-link href=#def-funding-signed-wire-message> # </a></h3><p>The fundee responds with their signature on the funding tx. With this signature, the funding tx is now ready for propagation by the funder.<p>This is the first message where we refer to the channel by its real channel id and not the random nonce.<p>See: <a href=https://github.com/lightningdevkit/rust-lightning/blob/711bcefbcc0999543d9622c030ff7dc8118fc26f/lightning/src/ln/msgs.rs#L235>https://github.com/lightningdevkit/rust-lightning/blob/711bcefbcc0999543d9622c030ff7dc8118fc26f/lightning/src/ln/msgs.rs#L235</a><pre class=language-rust data-lang=rust style=background-color:#2b303b;color:#c0c5ce;><code class=language-rust data-lang=rust><span style=color:#65737e;>/// A funding_signed message to be sent or received from a peer
</span><span style=color:#b48ead;>pub struct </span><span>FundingSigned {
</span><span>	</span><span style=color:#65737e;>/// The channel ID
</span><span>	</span><span style=color:#b48ead;>pub </span><span style=color:#bf616a;>channel_id</span><span>: [</span><span style=color:#b48ead;>u8</span><span>; 32],
</span><span>	</span><span style=color:#65737e;>/// The signature of the channel acceptor (fundee) on the
</span><span>	</span><span style=color:#65737e;>/// initial commitment transaction
</span><span>	</span><span style=color:#b48ead;>pub </span><span style=color:#bf616a;>signature</span><span>: Signature,
</span><span>}
</span></code></pre><h4 id=fundee-flow-3>fundee flow <a aria-label="anchor link" class=anchor-link href=#fundee-flow-3> # </a></h4><p>Fundee responds with <code>FundingSigned</code> message in tail-end of <a href=https://github.com/lightningdevkit/rust-lightning/blob/711bcefbcc0999543d9622c030ff7dc8118fc26f/lightning/src/ln/channel.rs#L4861><code>Channel::funding_created</code></a><h4 id=funder-flow-3>funder flow <a aria-label="anchor link" class=anchor-link href=#funder-flow-3> # </a></h4><p>Verify, hook channel monitor on tx, and broadcast funding tx: <a href=https://github.com/lightningdevkit/rust-lightning/blob/711bcefbcc0999543d9622c030ff7dc8118fc26f/lightning/src/ln/channelmanager.rs#L4519><code>ChannelManager::internal_funding_signed</code></a><p>Verify, build funding tx & tx monitor: <a href=https://github.com/lightningdevkit/rust-lightning/blob/711bcefbcc0999543d9622c030ff7dc8118fc26f/lightning/src/ln/channel.rs#L2126><code>Channel::funding_signed</code></a><p>Broadcast funding tx: <a href=https://github.com/lightningdevkit/rust-lightning/blob/711bcefbcc0999543d9622c030ff7dc8118fc26f/lightning/src/chain/chaininterface.rs#L19><code>chaininterface::BroadcasterInterface::broadcast_transaction</code></a><h3 id=def-funding-locked-wire-message>def: <code>funding_locked</code> wire message <a aria-label="anchor link" class=anchor-link href=#def-funding-locked-wire-message> # </a></h3><p>Each node watches the chain, waiting for the funding tx to confirm. Once a node sees the funding tx confirm, they send a <code>msgs::FundingLocked</code> message to the other peer.<p>Only once <strong>both peers</strong> have seen and verified that the funding tx has confirmed, and both peers have received each other's <code>FundingLocked</code> message, can the channel finally enter normal operating mode.<p>The peers use the real channel id here.<p>See: <a href=https://github.com/lightningdevkit/rust-lightning/blob/711bcefbcc0999543d9622c030ff7dc8118fc26f/lightning/src/ln/msgs.rs#L244>https://github.com/lightningdevkit/rust-lightning/blob/711bcefbcc0999543d9622c030ff7dc8118fc26f/lightning/src/ln/msgs.rs#L244</a><pre class=language-rust data-lang=rust style=background-color:#2b303b;color:#c0c5ce;><code class=language-rust data-lang=rust><span style=color:#65737e;>/// A funding_locked message to be sent or received from a peer
</span><span style=color:#b48ead;>pub struct </span><span>FundingLocked {
</span><span>	</span><span style=color:#65737e;>/// The channel ID
</span><span>	</span><span style=color:#b48ead;>pub </span><span style=color:#bf616a;>channel_id</span><span>: [</span><span style=color:#b48ead;>u8</span><span>; 32],
</span><span>	</span><span style=color:#65737e;>/// The per-commitment point of the second commitment transaction
</span><span>	</span><span style=color:#b48ead;>pub </span><span style=color:#bf616a;>next_per_commitment_point</span><span>: PublicKey,
</span><span>	</span><span style=color:#65737e;>/// If set, provides a short_channel_id alias for this channel.
</span><span>	</span><span style=color:#65737e;>/// The sender will accept payments to be forwarded over this
</span><span>	</span><span style=color:#65737e;>/// SCID and forward them to this messages' recipient.
</span><span>	</span><span style=color:#b48ead;>pub </span><span style=color:#bf616a;>short_channel_id_alias</span><span>: Option<</span><span style=color:#b48ead;>u64</span><span>>,
</span><span>}
</span></code></pre><h4 id=funder-fundee-flow>funder & fundee flow <a aria-label="anchor link" class=anchor-link href=#funder-fundee-flow> # </a></h4><h5 id=on-funding-tx-confirmation>On funding tx confirmation <a aria-label="anchor link" class=anchor-link href=#on-funding-tx-confirmation> # </a></h5><p>The <code>ChannelManager</code> on both sides will get poked when the funding tx is sufficiently confirmed. There appear to be several different possible interfaces, depending on how the chain listening is setup, like whether we're connected to a full node or light node, or if we have some block filtering etc...<p>The two I can see right off the bat are the traits <a href=https://github.com/lightningdevkit/rust-lightning/blob/711bcefbcc0999543d9622c030ff7dc8118fc26f/lightning/src/chain/mod.rs#L90><code>chain::Listen</code></a> (whole new blocks) and <a href=https://github.com/lightningdevkit/rust-lightning/blob/711bcefbcc0999543d9622c030ff7dc8118fc26f/lightning/src/chain/mod.rs#L130><code>chain::Confirm</code></a> (only specific txs we're interested in, only block headers).<p>You choose <code>chain::Listen</code> if you're connected to a full node and <code>chain::Confirm</code> if you're connected to a light node (my speculation).<p>These interfaces are impl'd by <code>ChannelManager</code>, who will eventually call <a href=https://github.com/lightningdevkit/rust-lightning/blob/711bcefbcc0999543d9622c030ff7dc8118fc26f/lightning/src/ln/channelmanager.rs#L5696><code>ChannelManager::do_chain_event</code></a> with a callback, which can possibly generate a <code>FundingLocked</code> msg for sending to the other peer.<p>Each channel handles the tx confirm update in <a href=https://github.com/lightningdevkit/rust-lightning/blob/711bcefbcc0999543d9622c030ff7dc8118fc26f/lightning/src/ln/channel.rs#L4561><code>Channel::transactions_confirmed</code></a>. Check if the tx is relevant and sufficiently confirmed, then generate the <code>FundingLocked</code> msg in <a href=https://github.com/lightningdevkit/rust-lightning/blob/711bcefbcc0999543d9622c030ff7dc8118fc26f/lightning/src/ln/channel.rs#L4508><code>Channel::check_get_funding_locked</code></a>.<p>If the <a href=https://github.com/lightningdevkit/rust-lightning/blob/711bcefbcc0999543d9622c030ff7dc8118fc26f/lightning/src/ln/channel.rs#L4456><code>Channel::is_usable</code></a> (both sides confirmed), then also <a href=https://github.com/lightningdevkit/rust-lightning/blob/711bcefbcc0999543d9622c030ff7dc8118fc26f/lightning/src/ln/channel.rs#L4935><code>Channel::get_announcement_sigs</code></a>, which generates a <a href=https://github.com/lightningdevkit/rust-lightning/blob/711bcefbcc0999543d9622c030ff7dc8118fc26f/lightning/src/ln/msgs.rs#L399><code>msgs::AccountmentSignatures</code></a> for sending, announcing the new channel.<p>Once the channel <code>is_usable</code>, we enter <a href=https://phlip9.com/notes/btc-ln/BOLT%202%20-%20channel%20management%20protocol/#normal-channel-operation>Normal Channel Operation</a>.<h5 id=on-remote-funding-locked-msg-rx>On remote <code>funding_locked</code> msg rx <a aria-label="anchor link" class=anchor-link href=#on-remote-funding-locked-msg-rx> # </a></h5><p>Rx peer's <code>funding_locked</code> msg: <a href=https://github.com/lightningdevkit/rust-lightning/blob/711bcefbcc0999543d9622c030ff7dc8118fc26f/lightning/src/ln/channelmanager.rs#L4555><code>ChannelManager::internal_funding_locked</code></a><p>Update the channel state w/ <a href=https://github.com/lightningdevkit/rust-lightning/blob/711bcefbcc0999543d9622c030ff7dc8118fc26f/lightning/src/ln/channel.rs#L2201><code>Channel::funding_locked</code></a>.<p>Like before, if the channel is now usable (both sides confirmed), is configured for announcement, and is announcable, then generate, sign, and send the <code>msg::AnnouncementSignatures</code>.<p>(not clear to me yet when these are announced)<p>Once the channel <code>is_usable</code>, we enter <a href=https://phlip9.com/notes/btc-ln/BOLT%202%20-%20channel%20management%20protocol/#normal-channel-operation>Normal Channel Operation</a>.<h2 id=cooperative-channel-close>Cooperative Channel Close <a aria-label="anchor link" class=anchor-link href=#cooperative-channel-close> # </a></h2><p>Both nodes can agree to graceful close a channel. This process consumes less fees and lets both sides access their funds immediately.<p>The other alternatives are unilateral close (maybe someone crashed) and revoked transaction close (the counterparty deliberately cheats and broadcasts an old state).<p>One side begins active <code>shutdown</code> of the channel and indicates how/where they want to be paid. The passive <code>shutdown</code> side responds similarly. Once a side has observed a <code>shutdown</code>, they will no longer accept new HTLCs on this channel. Once the <code>shutdown</code> is begun, both sides will wait for all <del>pending HTLCs to resolve</del> pending HTLCs to fail backwards. Once all HTLCs have resolved, both sides negotiate a final fee amount and broadcast the channel closure tx.<p>Protocol Diagram<pre style=background-color:#2b303b;color:#c0c5ce;><code><span>+-------+                              +-------+
</span><span>|       |--(1)-----  shutdown  ------->|       |
</span><span>|       |&LT-(2)-----  shutdown  --------|       |
</span><span>|       |                              |       |
</span><span>|       | &LTcomplete all pending HTLCs> |       |
</span><span>|   A   |                 ...          |   B   |
</span><span>|       |                              |       |
</span><span>|       |--(3)-- closing_signed  F1--->|       |
</span><span>|       |&LT-(4)-- closing_signed  F2----|       |
</span><span>|       |              ...             |       |
</span><span>|       |--(?)-- closing_signed  Fn--->|       |
</span><span>|       |&LT-(?)-- closing_signed  Fn----|       |
</span><span>+-------+                              +-------+
</span></code></pre><h3 id=def-shutdown-wire-message>def: <code>shutdown</code> wire message <a aria-label="anchor link" class=anchor-link href=#def-shutdown-wire-message> # </a></h3><p>See: <a href=https://github.com/lightningdevkit/rust-lightning/blob/711bcefbcc0999543d9622c030ff7dc8118fc26f/lightning/src/ln/msgs.rs#L256>https://github.com/lightningdevkit/rust-lightning/blob/711bcefbcc0999543d9622c030ff7dc8118fc26f/lightning/src/ln/msgs.rs#L256</a><pre class=language-rust data-lang=rust style=background-color:#2b303b;color:#c0c5ce;><code class=language-rust data-lang=rust><span style=color:#65737e;>/// A shutdown message to be sent or received from a peer
</span><span style=color:#b48ead;>pub struct </span><span>Shutdown {
</span><span>	</span><span style=color:#65737e;>/// The channel ID
</span><span>	</span><span style=color:#b48ead;>pub </span><span style=color:#bf616a;>channel_id</span><span>: [</span><span style=color:#b48ead;>u8</span><span>; 32],
</span><span>	</span><span style=color:#65737e;>/// The destination of this peer's funds on closing.
</span><span>	</span><span style=color:#65737e;>/// Must be in one of these forms: p2pkh, p2sh, p2wpkh, p2wsh.
</span><span>	</span><span style=color:#b48ead;>pub </span><span style=color:#bf616a;>scriptpubkey</span><span>: Script,
</span><span>}
</span></code></pre><h4 id=active-closer>active closer <a aria-label="anchor link" class=anchor-link href=#active-closer> # </a></h4><p><a href=https://github.com/lightningdevkit/rust-lightning/blob/711bcefbcc0999543d9622c030ff7dc8118fc26f/lightning/src/ln/channelmanager.rs#L2088><code>ChannelManager::close_channel</code></a> which immediately calls <a href=https://github.com/lightningdevkit/rust-lightning/blob/711bcefbcc0999543d9622c030ff7dc8118fc26f/lightning/src/ln/channelmanager.rs#L2009><code>ChannelManager::close_channel_internal</code></a>. chanmgr grabs the channel, moves it into shutdown mode, maybe updates monitor w/ new shutdown script, sends shutdown msg to peer. Then fails all pending HTLCs backwards: <a href=https://github.com/lightningdevkit/rust-lightning/blob/711bcefbcc0999543d9622c030ff7dc8118fc26f/lightning/src/ln/channelmanager.rs#L3745><code>ChannelManager::fail_htlc_backwards</code></a>. I guess we don't wait for HTLCs to resolve, just notify that they should fail.<p>Begin channel shutdown, craft <code>Shutdown</code> message, return failed HTLCs: <a href=https://github.com/lightningdevkit/rust-lightning/blob/711bcefbcc0999543d9622c030ff7dc8118fc26f/lightning/src/ln/channel.rs#L5423><code>Channel::get_shutdown</code></a><h4 id=passive-closer>passive closer <a aria-label="anchor link" class=anchor-link href=#passive-closer> # </a></h4><p>Notify the channel about the remote <code>shutdown</code>. Maybe update the monitor w/ shutdown script. Send the <code>shutdown</code> response msg. Fail any pending HTLCs. <a href=https://github.com/lightningdevkit/rust-lightning/blob/711bcefbcc0999543d9622c030ff7dc8118fc26f/lightning/src/ln/channelmanager.rs#L3745><code>ChannelManager::internal_shutdown</code></a><p>Channel rx'd <code>shutdown</code> msg from remote peer; maybe generate a <code>shutdown</code> response msg: <a href=https://github.com/lightningdevkit/rust-lightning/blob/711bcefbcc0999543d9622c030ff7dc8118fc26f/lightning/src/ln/channel.rs#L3987><code>Channel::shutdown</code></a><h3 id=def-closing-signed-wire-message>def: <code>closing_signed</code> wire message <a aria-label="anchor link" class=anchor-link href=#def-closing-signed-wire-message> # </a></h3><p>The channel is officially shutdown and all pending HTLCs are resolved or failed. Now both peers must negotiate a fee for the closing transaction.<p>There are two negotiation methods: (1) the "old" method, where nodes go back and forth proposing a "fair" fee and either accepting or rejecting with their new fee, and (2) the "modern" method, where the funder proposes a permissible fee range, and the fundee chooses a value from the range.<p>See: <a href=https://github.com/lightningdevkit/rust-lightning/blob/711bcefbcc0999543d9622c030ff7dc8118fc26f/lightning/src/ln/msgs.rs#L279>https://github.com/lightningdevkit/rust-lightning/blob/711bcefbcc0999543d9622c030ff7dc8118fc26f/lightning/src/ln/msgs.rs#L279</a><pre class=language-rust data-lang=rust style=background-color:#2b303b;color:#c0c5ce;><code class=language-rust data-lang=rust><span style=color:#65737e;>/// A closing_signed message to be sent or received from a peer
</span><span style=color:#b48ead;>pub struct </span><span>ClosingSigned {
</span><span>	</span><span style=color:#65737e;>/// The channel ID
</span><span>	</span><span style=color:#b48ead;>pub </span><span style=color:#bf616a;>channel_id</span><span>: [</span><span style=color:#b48ead;>u8</span><span>; 32],
</span><span>	</span><span style=color:#65737e;>/// The proposed total fee for the closing transaction
</span><span>	</span><span style=color:#b48ead;>pub </span><span style=color:#bf616a;>fee_satoshis</span><span>: </span><span style=color:#b48ead;>u64</span><span>,
</span><span>	</span><span style=color:#65737e;>/// A signature on the closing transaction
</span><span>	</span><span style=color:#b48ead;>pub </span><span style=color:#bf616a;>signature</span><span>: Signature,
</span><span>	</span><span style=color:#65737e;>/// The minimum and maximum fees which the sender is willing
</span><span>	</span><span style=color:#65737e;>/// to accept, provided only by new nodes.
</span><span>	</span><span style=color:#b48ead;>pub </span><span style=color:#bf616a;>fee_range</span><span>: Option&LTClosingSignedFeeRange>,
</span><span>}
</span><span>
</span><span style=color:#65737e;>/// The minimum and maximum fees which the sender is willing to place
</span><span style=color:#65737e;>/// on the closing transaction. This is provided in [`ClosingSigned`]
</span><span style=color:#65737e;>/// by both sides to indicate the fee range they are willing to use.
</span><span style=color:#b48ead;>pub struct </span><span>ClosingSignedFeeRange {
</span><span>	</span><span style=color:#65737e;>/// The minimum absolute fee, in satoshis, which the sender is
</span><span>	</span><span style=color:#65737e;>/// willing to place on the closing transaction.
</span><span>	</span><span style=color:#b48ead;>pub </span><span style=color:#bf616a;>min_fee_satoshis</span><span>: </span><span style=color:#b48ead;>u64</span><span>,
</span><span>	</span><span style=color:#65737e;>/// The maximum absolute fee, in satoshis, which the sender is
</span><span>	</span><span style=color:#65737e;>/// willing to place on the closing transaction.
</span><span>	</span><span style=color:#b48ead;>pub </span><span style=color:#bf616a;>max_fee_satoshis</span><span>: </span><span style=color:#b48ead;>u64</span><span>,
</span><span>}
</span></code></pre><h2 id=normal-channel-operation>Normal Channel Operation <a aria-label="anchor link" class=anchor-link href=#normal-channel-operation> # </a></h2><p>Protocol Diagram<pre style=background-color:#2b303b;color:#c0c5ce;><code><span>+-------+                               +-------+
</span><span>|       |--(1)---- update_add_htlc ---->|       |
</span><span>|       |--(2)---- update_add_htlc ---->|       |
</span><span>|       |&LT-(3)---- update_add_htlc -----|       |
</span><span>|       |                               |       |
</span><span>|       |--(4)--- commitment_signed --->|       |
</span><span>|   A   |&LT-(5)---- revoke_and_ack ------|   B   |
</span><span>|       |                               |       |
</span><span>|       |&LT-(6)--- commitment_signed ----|       |
</span><span>|       |--(7)---- revoke_and_ack ----->|       |
</span><span>|       |                               |       |
</span><span>|       |--(8)--- commitment_signed --->|       |
</span><span>|       |&LT-(9)---- revoke_and_ack ------|       |
</span><span>+-------+                               +-------+
</span></code></pre><p>TODO(philiphayes): finish this section<h3 id=def-update-add-htlc-wire-message>def: <code>update_add_htlc</code> wire message <a aria-label="anchor link" class=anchor-link href=#def-update-add-htlc-wire-message> # </a></h3><pre class=language-rust data-lang=rust style=background-color:#2b303b;color:#c0c5ce;><code class=language-rust data-lang=rust><span style=color:#65737e;>/// An update_add_htlc message to be sent or received from a peer
</span><span style=color:#b48ead;>pub struct </span><span>UpdateAddHTLC {
</span><span>	</span><span style=color:#65737e;>/// The channel ID
</span><span>	</span><span style=color:#b48ead;>pub </span><span style=color:#bf616a;>channel_id</span><span>: [</span><span style=color:#b48ead;>u8</span><span>; 32],
</span><span>	</span><span style=color:#65737e;>/// The HTLC ID
</span><span>	</span><span style=color:#b48ead;>pub </span><span style=color:#bf616a;>htlc_id</span><span>: </span><span style=color:#b48ead;>u64</span><span>,
</span><span>	</span><span style=color:#65737e;>/// The HTLC value in milli-satoshi
</span><span>	</span><span style=color:#b48ead;>pub </span><span style=color:#bf616a;>amount_msat</span><span>: </span><span style=color:#b48ead;>u64</span><span>,
</span><span>	</span><span style=color:#65737e;>/// The payment hash, the pre-image of which controls HTLC redemption
</span><span>	</span><span style=color:#b48ead;>pub </span><span style=color:#bf616a;>payment_hash</span><span>: PaymentHash,
</span><span>	</span><span style=color:#65737e;>/// The expiry height of the HTLC
</span><span>	</span><span style=color:#b48ead;>pub </span><span style=color:#bf616a;>cltv_expiry</span><span>: </span><span style=color:#b48ead;>u32</span><span>,
</span><span>	</span><span style=color:#b48ead;>pub</span><span>(</span><span style=color:#b48ead;>crate</span><span>) </span><span style=color:#bf616a;>onion_routing_packet</span><span>: OnionPacket,
</span><span>}
</span></code></pre></main></div></div></div><form class=d-none id=search-bar><div class=container><div class="row justify-content-center"><div class="col col-lg-11 col-xl-9" id=search-container><input aria-label="Search notes..." class="form-control is-search" placeholder="Search notes..." autocomplete=off id=userinput type=search><div class="shadow rounded" id=suggestions></div></div></div></div></form><script defer src=https://phlip9.com/notes/js/elasticlunr.min.js></script><script defer src=https://phlip9.com/notes/search_index.en.js></script><script defer src=https://phlip9.com/notes/js/search.js></script>